// =========================
// ========== Code.gs ======
// =========================

/** 各倉別對應的 Google Sheet ID */
const WAREHOUSE_IDS = {
  'TAO1': '1_bhGQdx0YH7lsqPFEq5___6_Nwq_gbelJmIHv0bmaIE',
  'TAO3': '1cffI2jIVZA1uSiAyaLLXXgPzDByhy87xznaN85O7wEE',
  'TAO4': '1tVxQbV0298fn2OXWAF0UqZa7FLbypsatciatxs4YVTU',
  'TAO5': '1jzVXC6gt36hJtlUHoxtTzZLMNj4EtTsd4k8eNB1bdiA',
  'TAO6': '1wwPLSLjl2abfM_OMdTNI9PoiPKo3waCV_y0wmx2DxAE',
  'TAO7': '16nGCqRO8DYDm0PbXFbdt-fiEFZCXxXjlOWjKU67p4LY',
  'TAO10': '1y0w49xdFlHvcVtgtG8fq6zdrF26y8j7HMFh5ujzUyR4'
};

/** 預設倉別（登入與預設畫面） */
const DEFAULT_WAREHOUSE_KEY = 'TAO1';

/** 固定讀取一份表（TAO1，可自行更改這一個 ID)
 * 目前用於登入驗證與預設倉別
 */
const SPREADSHEET_ID = WAREHOUSE_IDS[DEFAULT_WAREHOUSE_KEY];

/** 不當作分頁選項的分頁（登入用、調動紀錄等）*/
const EXCLUDED_SHEETS = ['生日管理', '變動記錄'];

/** 登入驗證用分頁名稱（在 SPREADSHEET_ID 裡）*/
const LOGIN_SHEET_NAME = '生日管理';

/** MASTER INDEX 試算表：用來先查姓名/生日/倉別（A=姓名,B=生日,C=倉別） */
const MASTER_INDEX_SPREADSHEET_ID = '12ce9KH2Zjs4mQ90d0yxvwww4gnjpOuEKg7eFWTec0oQ';
const MASTER_INDEX_SHEET_NAME = 'index';

/** 依傳入倉別 key (如 "TAO3") 取得實際試算表 ID，若無則改用預設 TAO1 */
function resolveWarehouse_(wh) {
  var key = normWhKey_(wh);
  if (!WAREHOUSE_IDS[key]) key = DEFAULT_WAREHOUSE_KEY;
  return { key: key, id: WAREHOUSE_IDS[key] };
}

function fastPayloadForName_(ss, sh, sheetName, name, lastRow, lastCol, frozenLeft) {
  var maxCheck = Math.min(lastRow, 3);
  var headVals = sh.getRange(1, 1, maxCheck, lastCol).getDisplayValues();
  if (!headVals || !headVals.length) return null;

  var headerRowIndex = detectHeaderRowIndex_(headVals);
  var headers = headVals[headerRowIndex] || [];
  var headersISO = headers.map(guessISOFromHeaderText_);

  var dateCols = [];
  for (var i = 0; i < headersISO.length; i++) {
    if (headersISO[i]) dateCols.push(i);
  }

  var dataStartRow = headerRowIndex + 2;
  if (dataStartRow > lastRow) {
    return {
      headers: headers,
      headersISO: headersISO,
      headersTop: headerRowIndex > 0 ? headVals[0] : [],
      rows: [],
      dateCols: dateCols,
      frozenLeft: frozenLeft,
      engine: 'fast',
      counts: { rows: 0, cols: headers.length }
    };
  }

  var nameCol = findNameCol_(headers);
  if (nameCol < 0) return null;

  var nameVals = sh.getRange(dataStartRow, nameCol + 1, lastRow - (dataStartRow - 1), 1).getDisplayValues();
  var target = normName_(name);
  var matchRows = [];
  for (var r = 0; r < nameVals.length; r++) {
    var cell = nameVals[r] && nameVals[r][0] != null ? String(nameVals[r][0]) : '';
    if (!cell) continue;
    if (normName_(cell) === target) {
      matchRows.push(dataStartRow + r);
    }
  }

  var rows = [];
  if (matchRows.length) {
    var minR = matchRows[0];
    var maxR = matchRows[0];
    var set = {};
    for (var k = 0; k < matchRows.length; k++) {
      var rr = matchRows[k];
      set[rr] = true;
      if (rr < minR) minR = rr;
      if (rr > maxR) maxR = rr;
    }

    var rng = sh.getRange(minR, 1, maxR - minR + 1, lastCol);
    var vals = rng.getDisplayValues();
    var bgs = rng.getBackgrounds();
    var fcs = rng.getFontColors();

    for (var off = 0; off < vals.length; off++) {
      var absRow = minR + off;
      if (!set[absRow]) continue;
      rows.push({
        v: vals[off].map(function (x) { return String(x == null ? '' : x); }),
        bg: bgs[off].slice(),
        fc: fcs[off].slice()
      });
    }
  }

  var payload = {
    headers: headers,
    headersISO: headersISO,
    headersTop: headerRowIndex > 0 ? headVals[0] : [],
    rows: rows,
    dateCols: dateCols,
    frozenLeft: frozenLeft,
    engine: 'fast',
    counts: { rows: rows.length, cols: headers.length }
  };

  attachAttendanceFlagsForRows_(ss, sheetName, payload, rows);
  return payload;
}

/**
 * 網頁入口
 * 預設回傳 index.html
 * mode=api 時回傳指定分頁＋指定姓名的資料
 * mode=getSheets 時回傳該倉別的可選分頁清單
 * mode=getAllPeopleCount 時回傳所有倉別人數
 * 可加 wh=TAO3 / TAO4 ... 切換倉別（目前只給管理者前端使用）
 */
function doGet(e) {
  var whParam = e && e.parameter && e.parameter.wh;
  var resolved = resolveWarehouse_(whParam);
  var warehouseKey = resolved.key;
  var ssid = resolved.id;

  //  只回傳指定倉別的試算表 ID（給前端「開啟各倉試算表」用）
  // 注意：此模式不做預設倉別回退；若倉別不存在就回傳錯誤
  if (e && e.parameter && e.parameter.mode === 'getWarehouseId') {
    var rawKey = normWhKey_(whParam);
    if (!rawKey || !WAREHOUSE_IDS[rawKey]) {
      return ContentService.createTextOutput(
        JSON.stringify({ ok: false, error: '找不到倉別試算表 ID：' + rawKey })
      ).setMimeType(ContentService.MimeType.JSON);
    }
    return ContentService.createTextOutput(
      JSON.stringify({ ok: true, warehouse: rawKey, spreadsheetId: WAREHOUSE_IDS[rawKey] })
    ).setMimeType(ContentService.MimeType.JSON);
  }

  // 回傳所有倉別人數（給前端 KPI 用）
  if (e && e.parameter && e.parameter.mode === 'getAllPeopleCount') {
    var countData = getAllPeopleCount_();
    return ContentService.createTextOutput(
      JSON.stringify({
        totalPeople: countData.total,
        details: countData.details
      })
    ).setMimeType(ContentService.MimeType.JSON);
  }

  // 只回傳指定倉別的分頁清單（給前端管理者切換倉別用）
  if (e && e.parameter && e.parameter.mode === 'getSheets') {
    var namesForApi = getSheetNames_(ssid);
    return ContentService.createTextOutput(
      JSON.stringify({
        warehouse: warehouseKey,
        sheetNames: namesForApi
      })
    ).setMimeType(ContentService.MimeType.JSON);
  }

  //  登入驗證（給前端 LoginPage 用）
  if (e && e.parameter && e.parameter.mode === 'verifyLogin') {
    var nm = String(e.parameter.name || '').trim();
    var bd = String(e.parameter.birthday || '').trim();
    var res = verifyLogin(nm, bd);
    return ContentService.createTextOutput(JSON.stringify(res))
      .setMimeType(ContentService.MimeType.JSON);
  }

  // ✅ 依姓名查詢倉別（給前端「姓名辨識倉別」用 / Vercel 也可用）
  if (e && e.parameter && e.parameter.mode === 'findWarehouseByName') {
    var nmFind = tryDecodeOnce_(e.parameter.name || '');
    try {
      var whFind = lookupWarehouseKeyByNameFromIndex_(nmFind);
      return ContentService.createTextOutput(JSON.stringify({ ok: true, warehouseKey: whFind }))
        .setMimeType(ContentService.MimeType.JSON);
    } catch (errFind) {
      return ContentService.createTextOutput(JSON.stringify({ ok: false, error: String(errFind) }))
        .setMimeType(ContentService.MimeType.JSON);
    }
  }

  var sheetNames = getSheetNames_(ssid);

  // 預設分頁：優先「出勤記錄」，再來「班表」，找不到就用第一個
  var prefer = '';
  if (sheetNames.indexOf('出勤記錄') >= 0) {
    prefer = '出勤記錄';
  } else if (sheetNames.indexOf('班表') >= 0) {
    prefer = '班表';
  } else {
    prefer = sheetNames[0] || '';
  }

  var rawSheet = (e && e.parameter && e.parameter.sheet) || '';
  var pick = tryDecodeOnce_(rawSheet);
  var sheetName = '';
  var wantKey = normSheetKey_(pick);
  if (wantKey) {
    for (var si = 0; si < sheetNames.length; si++) {
      if (normSheetKey_(sheetNames[si]) === wantKey) {
        sheetName = sheetNames[si];
        break;
      }
    }
  }
  if (!sheetName) sheetName = prefer;

  // 資料 API：只回傳指定姓名的列
  if (e && e.parameter && e.parameter.mode === 'api') {
    var loginName = (e.parameter.name || '').trim();
    try {
      var targetWarehouseKey = warehouseKey;
      var targetSsid = ssid;
      if (String(loginName || '').trim()) {
        targetWarehouseKey = lookupWarehouseKeyByNameFromIndex_(loginName);
        if (!WAREHOUSE_IDS[targetWarehouseKey]) {
          throw new Error('INDEX 倉別無效：' + targetWarehouseKey);
        }
        targetSsid = WAREHOUSE_IDS[targetWarehouseKey];
      }

      var sheetNamesForApi = getSheetNames_(targetSsid);
      var preferForApi = '';
      if (sheetNamesForApi.indexOf('出勤記錄') >= 0) {
        preferForApi = '出勤記錄';
      } else if (sheetNamesForApi.indexOf('班表') >= 0) {
        preferForApi = '班表';
      } else {
        preferForApi = sheetNamesForApi[0] || '';
      }

      var rawSheetForApi = (e && e.parameter && e.parameter.sheet) || '';
      var pickForApi = tryDecodeOnce_(rawSheetForApi);
      var sheetNameForApi = '';
      var wantKeyApi = normSheetKey_(pickForApi);
      if (wantKeyApi) {
        for (var sj = 0; sj < sheetNamesForApi.length; sj++) {
          if (normSheetKey_(sheetNamesForApi[sj]) === wantKeyApi) {
            sheetNameForApi = sheetNamesForApi[sj];
            break;
          }
        }
      }
      if (!sheetNameForApi) sheetNameForApi = preferForApi;

      var payload = getGridPayloadForName_(sheetNameForApi, targetSsid, loginName);
      payload.requestedSheetRaw = rawSheetForApi;
      payload.requestedSheetDecoded = pickForApi;
      payload.sheetNameUsed = sheetNameForApi;
      payload.availableSheets = sheetNamesForApi;
      payload.warehouse = targetWarehouseKey;
      payload.spreadsheetId = targetSsid;
      return ContentService.createTextOutput(JSON.stringify(payload))
        .setMimeType(ContentService.MimeType.JSON);
    } catch (err) {
      return ContentService.createTextOutput(JSON.stringify({ error: String(err) }))
        .setMimeType(ContentService.MimeType.JSON);
    }
  }

  // 一般瀏覽：回傳畫面
  var t = HtmlService.createTemplateFromFile('index');
  t.whKey = warehouseKey;
  t.whKeys = Object.keys(WAREHOUSE_IDS);
  t.whIds = WAREHOUSE_IDS;
  t.sheetNames = sheetNames;
  t.sheetName = sheetName;
  return t
    .evaluate()
    .setTitle('寶佳鋼鐵表 - 登入')
    .setXFrameOptionsMode(HtmlService.XFrameOptionsMode.ALLOWALL);
}

function norm_(s) {
  return String(s || '').trim();
}

function normName_(s) {
  return norm_(s).replace(/[\s\u00A0\u3000\u200B]+/g, '');
}

function normBirth_(s) {
  return norm_(s).replace(/[\/\-\.\s]/g, '');
}

function normWhKey_(s) {
  return norm_(s).replace(/\s+/g, '').toUpperCase();
}

function normSheetKey_(s) {
  return String(s || '')
    .replace(/[\u00A0\u3000]/g, ' ')
    .replace(/\s+/g, ' ')
    .trim();
}

function getSheetNames_(spreadsheetId) {
  var cache = CacheService.getScriptCache();
  var cacheKey = 'sheetNames:' + String(spreadsheetId || '');
  try {
    var cached = cache.get(cacheKey);
    if (cached) {
      var parsed = JSON.parse(cached);
      if (Array.isArray(parsed)) return parsed;
    }
  } catch (_) { }

  var ss = SpreadsheetApp.openById(spreadsheetId);
  var all = ss.getSheets().map(function (s) { return s.getName(); });
  var out = all.filter(function (n) {
    var nk = normSheetKey_(n);
    for (var i = 0; i < EXCLUDED_SHEETS.length; i++) {
      if (normSheetKey_(EXCLUDED_SHEETS[i]) === nk) return false;
    }
    return true;
  });

  try {
    var json = JSON.stringify(out);
    if (json.length < 90000) cache.put(cacheKey, json, 5);
  } catch (_) { }

  return out;
}

function detectNameColByData_(rows, name) {
  if (!rows || !rows.length) return -1;
  var target = normName_(name);
  if (!target) return -1;

  var maxRows = Math.min(rows.length, 300);
  var maxCols = (rows[0] && rows[0].v) ? rows[0].v.length : 0;
  if (maxCols <= 0) return -1;

  for (var c = 0; c < maxCols; c++) {
    for (var r = 0; r < maxRows; r++) {
      var v = rows[r] && rows[r].v ? rows[r].v[c] : '';
      if (!v) continue;
      if (normName_(String(v)) === target) {
        return c;
      }
    }
  }
  return -1;
}

function getSheetByNameCI_(ss, name) {
  var exact = ss.getSheetByName(name);
  if (exact) return exact;
  var want = String(name || '').trim().toLowerCase();
  if (!want) return null;
  var sheets = ss.getSheets();
  for (var i = 0; i < sheets.length; i++) {
    var n = String(sheets[i].getName() || '').trim().toLowerCase();
    if (n === want) return sheets[i];
  }
  return null;
}

function lookupWarehouseKeyByNameFromIndex_(name) {
  var nm = normName_(name);
  if (!nm) return '';

  var cache = CacheService.getScriptCache();
  var cacheKey = 'idxWh:' + nm;
  try {
    var cached = cache.get(cacheKey);
    if (cached) return String(cached);
  } catch (_) { }

  var idxSs = SpreadsheetApp.openById(MASTER_INDEX_SPREADSHEET_ID);
  var idxSh = getSheetByNameCI_(idxSs, MASTER_INDEX_SHEET_NAME);
  if (!idxSh) {
    throw new Error('找不到 MASTER_INDEX 分頁：' + MASTER_INDEX_SHEET_NAME);
  }

  var idxLast = idxSh.getLastRow();
  if (idxLast < 2) {
    throw new Error('MASTER_INDEX 尚無資料');
  }

  var idxVals = idxSh.getRange(2, 1, idxLast - 1, 3).getDisplayValues();
  var whSet = {};

  for (var i = 0; i < idxVals.length; i++) {
    var n = normName_(idxVals[i][0]);
    if (n !== nm) continue;
    var wh = normWhKey_(idxVals[i][2]);
    if (wh) whSet[wh] = true;
  }

  var keys = Object.keys(whSet);
  if (keys.length === 1) {
    try { cache.put(cacheKey, String(keys[0]), 600); } catch (_) { }
    return keys[0];
  }
  if (keys.length > 1) {
    throw new Error('INDEX 同名多倉，請指定倉別：' + nm + ' → ' + keys.join(','));
  }
  throw new Error('INDEX 找不到該姓名的倉別：' + nm);
}

// ✅ 給 html.txt 用 google.script.run 呼叫（避免在嵌入頁面用 fetch 造成 Failed to fetch）
function findWarehouseByName(name) {
  try {
    var wh = lookupWarehouseKeyByNameFromIndex_(name);
    return { ok: true, warehouseKey: wh };
  } catch (err) {
    return { ok: false, error: String(err) };
  }
}

/**
 * 登入驗證
 * name：姓名；birthday：生日（文字比較，不限制位數）
 * 規則：
 *  - 管理者：姓名=「酷澎」＆生日=「0000」→ 直接通過，不看試算表
 *  - 一般使用者：
 *      1) 先查 MASTER_INDEX/index：A=姓名、B=生日、C=倉別 → 姓名+生日相符才取倉別
 *      2) 再去該倉試算表的登入驗證分頁中，A欄=姓名 且 B欄=生日 才通過
 *      3) 回傳 warehouseKey 給前端鎖定倉別
 */
function verifyLogin(name, birthday) {
  name = normName_(name);
  birthday = norm_(birthday);

  if (!name || !birthday) {
    return { ok: false, msg: '請輸入姓名與生日' };
  }

  // 管理者帳號：不用驗證分頁
  if (name === '酷澎' && birthday === '0000') {
    return { ok: true, isAdmin: true, name: name, warehouseKey: DEFAULT_WAREHOUSE_KEY };
  }

  // 1) MASTER_INDEX：A=姓名 B=生日 C=倉別
  var cache = CacheService.getScriptCache();
  var ck = 'idxLogin:' + name + ':' + normBirth_(birthday);
  try {
    var cachedWh = cache.get(ck);
    if (cachedWh) {
      var whCached = normWhKey_(cachedWh);
      if (whCached) {
        var ssidCached = WAREHOUSE_IDS[whCached];
        if (ssidCached) {
          return verifyBirthdayInWarehouse_(whCached, ssidCached, name, birthday);
        }
      }
    }
  } catch (_) { }

  var idxSs = SpreadsheetApp.openById(MASTER_INDEX_SPREADSHEET_ID);
  var idxSh = getSheetByNameCI_(idxSs, MASTER_INDEX_SHEET_NAME);
  if (!idxSh) {
    return { ok: false, msg: '找不到 MASTER_INDEX 分頁：' + MASTER_INDEX_SHEET_NAME };
  }

  var idxLast = idxSh.getLastRow();
  if (idxLast < 2) {
    return { ok: false, msg: 'MASTER_INDEX 尚無資料' };
  }

  var idxVals = idxSh.getRange(2, 1, idxLast - 1, 3).getDisplayValues();
  var warehouseKey = '';
  for (var i = 0; i < idxVals.length; i++) {
    var nm = normName_(idxVals[i][0]);
    var bd = normBirth_(idxVals[i][1]);
    var wh = normWhKey_(idxVals[i][2]);
    if (nm === name && bd && bd === normBirth_(birthday)) {
      warehouseKey = wh;
      break;
    }
  }

  if (!warehouseKey) {
    return { ok: false, msg: '姓名或生日不正確（INDEX）' };
  }

  var ssid = WAREHOUSE_IDS[warehouseKey];
  if (!ssid) {
    return { ok: false, msg: '倉別無效：' + warehouseKey };
  }

  try { cache.put(ck, warehouseKey, 600); } catch (_) { }
  return verifyBirthdayInWarehouse_(warehouseKey, ssid, name, birthday);
}

function verifyBirthdayInWarehouse_(warehouseKey, ssid, name, birthday) {
  var ss = SpreadsheetApp.openById(ssid);
  var sh = getSheetByNameCI_(ss, LOGIN_SHEET_NAME);
  if (!sh) {
    return { ok: false, msg: '找不到「' + LOGIN_SHEET_NAME + '」分頁（' + warehouseKey + '）' };
  }

  var last = sh.getLastRow();
  if (last < 2) {
    return { ok: false, msg: LOGIN_SHEET_NAME + '尚無資料（' + warehouseKey + '）' };
  }

  var vals = sh.getRange(2, 1, last - 1, 2).getDisplayValues();
  for (var j = 0; j < vals.length; j++) {
    var nm2 = normName_(vals[j][0]);
    var bd2 = normBirth_(vals[j][1]);
    if (nm2 === name && bd2 && bd2 === normBirth_(birthday)) {
      return { ok: true, isAdmin: false, name: name, warehouseKey: warehouseKey };
    }
  }

  return { ok: false, msg: '姓名或生日不正確（' + warehouseKey + ' 生日管理）' };
}

/**
 * 讀取指定分頁的資料，並只保留指定姓名的列
 * 回傳格式：
 *  {
 *    headers: [...],
 *    headersISO: [...],
 *    headersTop: [],
 *    rows: [{v:[...], bg:[...], fc:[...], att:[...]}...],
 *    dateCols: [數字...],
 *    frozenLeft: 整數,
 *    engine: 'basic',
 *    counts: {rows:筆數, cols:欄數}
 *  }
 */
function getGridPayloadForName_(sheetName, spreadsheetId, nameFilter) {
  var ss = SpreadsheetApp.openById(spreadsheetId);
  var sh = ss.getSheetByName(sheetName);
  if (!sh) throw new Error('找不到分頁：' + sheetName);

  var lastRow = sh.getLastRow();
  var lastCol = sh.getLastColumn();
  var frozenLeft = sh.getFrozenColumns() || 0;

  var nm = String(nameFilter || '').trim();
  if (nm && (lastRow * lastCol) >= 20000) {
    try {
      var fast = fastPayloadForName_(ss, sh, sheetName, nm, lastRow, lastCol, frozenLeft);
      if (fast) return fast;
    } catch (_) { }
  }

  if (lastRow < 1 || lastCol < 1) {
    return {
      headers: [],
      headersISO: [],
      headersTop: [],
      rows: [],
      dateCols: [],
      frozenLeft: frozenLeft,
      engine: 'basic',
      counts: { rows: 0, cols: 0 }
    };
  }

  // 依分頁尺寸簡單快取 5 秒（未依姓名區分，姓名篩選在快取之後）
  var cache = CacheService.getScriptCache();
  var cacheKey = 'grid:' + spreadsheetId + ':' + sheetName + ':' + lastRow + 'x' + lastCol;
  var base = null;

  try {
    var cached = cache.get(cacheKey);
    if (cached) base = JSON.parse(cached);
  } catch (_) { }

  if (!base) {
    base = readSheetToPayload_(sh, lastRow, lastCol);
    base.frozenLeft = frozenLeft;
    base.engine = 'basic';
    base.counts = { rows: base.rows.length, cols: base.headers.length };
    try {
      var json = JSON.stringify(base);
      if (json.length < 90000) cache.put(cacheKey, json, 5);
    } catch (_) { }
  }

  // 沒有指定姓名 → 回傳全部（給管理者用），一樣掛上出勤旗標
  var name = nm;
  if (!name) {
    attachAttendanceFlagsForRows_(ss, sheetName, base, base.rows);
    return base;
  }

  var nameCol = findNameCol_(base.headers);
  if (nameCol < 0) nameCol = detectNameColByData_(base.rows, name);
  if (nameCol < 0) throw new Error('找不到姓名欄位：' + sheetName);

  var filteredRows = base.rows.filter(function (row) {
    return normName_(String(row.v[nameCol] || '')) === normName_(name);
  });

  // 一般使用者 / API 指定姓名 → 僅對這些列掛上出勤旗標
  attachAttendanceFlagsForRows_(ss, sheetName, base, filteredRows);

  return {
    headers: base.headers,
    headersISO: base.headersISO,
    headersTop: base.headersTop || [],
    rows: filteredRows,
    dateCols: base.dateCols,
    frozenLeft: frozenLeft,
    engine: base.engine || 'basic',
    counts: { rows: filteredRows.length, cols: base.headers.length }
  };
}

/**
 * 把整個分頁讀成 payload（不做姓名篩選）
 *  支援「表頭 1 列或 2 列」：
 *   - 會自動判斷哪一列才是「真正欄位表頭」
 *   - TAO3 這種上面多一列標題的班表就不會被算進資料列
 */
function readSheetToPayload_(sh, lastRow, lastCol) {
  var rng = sh.getRange(1, 1, lastRow, lastCol);
  var values = rng.getDisplayValues();
  var bgs = rng.getBackgrounds();
  var fcs = rng.getFontColors();

  if (!values || !values.length) {
    return {
      headers: [],
      headersISO: [],
      headersTop: [],
      rows: [],
      dateCols: []
    };
  }

  // 根據前幾列內容自動判斷真正表頭列（支援 1 或 2 列表頭）
  var headerRowIndex = detectHeaderRowIndex_(values);

  var headers = values[headerRowIndex] || [];
  var headersISO = headers.map(guessISOFromHeaderText_);

  var dateCols = [];
  for (var i = 0; i < headersISO.length; i++) {
    if (headersISO[i]) dateCols.push(i);
  }

  var rows = [];
  for (var r = headerRowIndex + 1; r < values.length; r++) {
    rows.push({
      v: values[r].map(function (x) { return String(x == null ? '' : x); }),
      bg: bgs[r].slice(),
      fc: fcs[r].slice()
      // att 之後在 attachAttendanceFlagsForRows_ 再加
    });
  }

  return {
    headers: headers,
    headersISO: headersISO,
    // 若有 2 列表頭，這裡先保留第一列（目前前端沒用到，只做備份）
    headersTop: headerRowIndex > 0 ? values[0] : [],
    rows: rows,
    dateCols: dateCols
  };
}

/** 嘗試 decode 一次 URL 編碼 */
function tryDecodeOnce_(s) {
  if (!s) return '';
  try {
    return decodeURIComponent(s);
  } catch (e) {
    return s;
  }
}

/** 找「姓名」欄位位置（加強版，支援多種寫法） */
function findNameCol_(headers) {
  if (!headers || !headers.length) return -1;

  // 先比對完全相同的欄名
  var EXACT = ['姓名', 'Name', 'name', '員工姓名', '姓名(必填)', '中文姓名'];
  for (var i = 0; i < headers.length; i++) {
    var h = String(headers[i] || '').trim();
    if (!h) continue;
    if (EXACT.indexOf(h) >= 0) return i;
  }

  // 再用「包含關鍵字」的方式
  for (var j = 0; j < headers.length; j++) {
    var hh = String(headers[j] || '').trim();
    if (!hh) continue;
    if (
      hh.indexOf('姓名') >= 0 ||
      hh.indexOf('員工') >= 0 ||
      /^name$/i.test(hh) ||
      /employee/i.test(hh)
    ) {
      return j;
    }
  }
  return -1;
}

/**
 * 從表頭文字或日期字串猜日期（yyyy/mm/dd、mm/dd、yyyy年m月d日、m月d日）
 * 回傳 'YYYY-MM-DD' 或空字串
 */
function guessISOFromHeaderText_(t) {
  var s = String(t || '').trim();
  if (!s) return '';

  //  允許表頭帶星期/時間/括號等額外文字：先從字串中「擷取」日期
  // 1) yyyy/mm/dd 或 yyyy-mm-dd（允許後面有文字）
  var m = s.match(/(\d{4})[\/\-](\d{1,2})[\/\-](\d{1,2})/);
  if (m) {
    var y = m[1];
    var mo = ('0' + m[2]).slice(-2);
    var d = ('0' + m[3]).slice(-2);
    return y + '-' + mo + '-' + d;
  }

  // 2) yyyy年m月d日 或 m月d日（允許後面有文字）
  m = s.match(/(?:(\d{4})\s*年)?\s*(\d{1,2})\s*月\s*(\d{1,2})\s*日/);
  if (m) {
    var yy = m[1] || String(new Date().getFullYear());
    var mo3 = ('0' + m[2]).slice(-2);
    var d3 = ('0' + m[3]).slice(-2);
    return yy + '-' + mo3 + '-' + d3;
  }

  // 3) mm/dd 或 m/d（沒年份時用今年；避免誤抓年份中的片段）
  m = s.match(/(?:^|[^\d])(\d{1,2})[\/\-](\d{1,2})(?:$|[^\d])/);
  if (m) {
    var year = String(new Date().getFullYear());
    var mo2 = ('0' + m[1]).slice(-2);
    var d2 = ('0' + m[2]).slice(-2);
    return year + '-' + mo2 + '-' + d2;
  }

  return '';
}

/**
 * 根據前幾列內容自動判斷真正的欄位表頭所在列
 * - 會綜合「是否包含姓名/部門關鍵字」、「是否有日期格式」、「非空欄位數」來評分
 * - 目前只檢查前 3 列，回傳 0-based index
 * - TAO3 那種上面只有一行大標題、下面才是正式表頭，會自動選下面那一列
 */
function detectHeaderRowIndex_(values) {
  if (!values || !values.length) return 0;

  var maxCheck = Math.min(values.length, 3);
  var bestIdx = 0;
  var bestScore = -9999;

  for (var i = 0; i < maxCheck; i++) {
    var row = values[i] || [];
    var nonEmpty = 0;
    var hasName = 0;
    var hasDept = 0;
    var dateCount = 0;

    for (var j = 0; j < row.length; j++) {
      var s = String(row[j] || '').trim();
      if (!s) continue;
      nonEmpty++;

      if (
        s.indexOf('姓名') >= 0 ||
        /^name$/i.test(s) ||
        s.indexOf('員工') >= 0
      ) {
        hasName = 1;
      }
      if (
        s.indexOf('組別') >= 0 ||
        s.indexOf('部門') >= 0 ||
        /dept|department|group/i.test(s)
      ) {
        hasDept = 1;
      }
      if (guessISOFromHeaderText_(s)) {
        dateCount++;
      }
    }

    var score = nonEmpty + hasName * 5 + hasDept * 3 + dateCount * 2;

    // 若只有一個欄位有字，而且像是整表標題（欄數較多但只有第一格長字），稍微扣分
    if (nonEmpty === 1 && row.length >= 4 && String(row[0]).length > 4) {
      score -= 3;
    }

    if (score > bestScore || (score === bestScore && i > bestIdx)) {
      bestScore = score;
      bestIdx = i;
    }
  }

  return bestIdx;
}

/**
 * 對「班表」分頁的資料列，依姓名＋日期掛上出勤旗標 row.att
 * row.att[欄索引] = 1 表示該日有出勤紀錄，0 表示沒有
 */
function attachAttendanceFlagsForRows_(ss, sheetName, base, rows) {
  if (!rows || !rows.length) return;
  if (sheetName.indexOf('班表') < 0) return; // 只處理班表
  var dateCols = base.dateCols || [];
  if (!dateCols.length) return;

  var headersISO = base.headersISO || [];
  var nameCol = findNameCol_(base.headers);
  if (nameCol < 0) return;

  var attMap = buildAttendanceMap_(ss);
  if (!attMap) return;

  rows.forEach(function (row) {
    //  修正：統一姓名格式（去除空白/全形空白等），避免比對不到出勤紀錄
    var nm = normName_(String(row.v[nameCol] || ''));
    if (!nm) return;

    var att = [];
    for (var i = 0; i < base.headers.length; i++) att[i] = 0;

    dateCols.forEach(function (ci) {
      var iso = headersISO[ci];
      if (!iso) return;
      var headerText = String((base.headers && base.headers[ci]) || '').trim();
      var useMonthDay = false;
      if (!/\d{4}/.test(headerText)) {
        if (/^\d{1,2}[\/\-]\d{1,2}/.test(headerText) || /^\d{1,2}\s*月\s*\d{1,2}\s*日/.test(headerText)) {
          useMonthDay = true;
        }
      }

      var key = nm + '|' + iso;
      var hit = attMap[key];
      //  若班表表頭沒有年份（如 12/1、12/1(一)、12月1日），改用 MM-DD 比對避免跨年比對不到
      if (!hit && useMonthDay) {
        var mdKey = nm + '|' + iso.slice(5);
        hit = attMap[mdKey];
      }
      att[ci] = hit ? 1 : 0;
    });

    row.att = att;
  });
}

/**
 * 建立出勤紀錄查詢 map： key = 姓名|YYYY-MM-DD → true
 * 只抓分頁名稱含「出勤時數 / 出勤時間 / 出勤備份」
 *  同樣支援「表頭 2 列」的出勤表：自動判斷真正表頭列
 */
function buildAttendanceMap_(ss) {
  var map = {};

  var sheets = ss.getSheets();
  sheets.forEach(function (sh) {
    var sn = sh.getName();

    // 只要「分頁名稱內含」以下關鍵字之一就算出勤分頁
    if (
      sn.indexOf('出勤時數') < 0 &&
      sn.indexOf('出勤時間') < 0 &&
      sn.indexOf('出勤備份') < 0 &&
      sn.indexOf('出勤記錄') < 0 &&  //  新增
      sn.indexOf('出勤紀錄') < 0     //  新增（同義字）
    ) {
      return;
    }

    var lastRow = sh.getLastRow();
    var lastCol = sh.getLastColumn();
    if (lastRow < 2 || lastCol < 1) return;

    var vals = sh.getRange(1, 1, lastRow, lastCol).getDisplayValues();

    //  自動判斷真正表頭列（支援 1 或 2 列表頭）
    var headerRowIndex = detectHeaderRowIndex_(vals);
    var headers = vals[headerRowIndex] || [];

    // 姓名欄
    var nameCol = findNameCol_(headers);

    // 日期欄：欄位名稱只要「包含『日期』兩個字」就算
    var dateCol = -1;
    for (var i = 0; i < headers.length; i++) {
      var h = String(headers[i] || '').trim();
      if (h.indexOf('日期') >= 0) {
        dateCol = i;
        break;
      }
    }

    if (nameCol < 0 || dateCol < 0) return; // 這張表找不到姓名或日期，就略過

    for (var r = headerRowIndex + 1; r < vals.length; r++) {
      //  修正：統一姓名格式（去除空白/全形空白等），避免比對不到班表姓名
      var nm = normName_(String(vals[r][nameCol] || ''));
      var ds = String(vals[r][dateCol] || '').trim();
      if (!nm || !ds) continue;

      // 優先用 guessISOFromHeaderText_（吃 yyyy/mm/dd、m/d、yyyy年m月d日…）
      var iso = guessISOFromHeaderText_(ds);

      // 若上面沒解析出來，再試用 new Date() 解析
      if (!iso) {
        var d = new Date(ds);
        if (!isNaN(d.getTime())) {
          var y = d.getFullYear();
          var mo = ('0' + (d.getMonth() + 1)).slice(-2);
          var da = ('0' + d.getDate()).slice(-2);
          iso = y + '-' + mo + '-' + da;
        }
      }

      if (!iso) continue;

      var key = nm + '|' + iso;
      map[key] = true;
      //  同步建立 MM-DD key，避免班表表頭沒有年份時比對不到
      map[nm + '|' + iso.slice(5)] = true;
    }
  });

  return map;
}


/**
 * 統計所有倉別人數（不重複） - 修正版本
 * 回傳格式：{ total: 總人數, details: [{warehouse: 倉別, month: 月份, count: 人數, leaveCount: 離職人數}, ...] }
 */
function getAllPeopleCount_() {
  var cache = CacheService.getScriptCache();
  var cacheKey = 'allPeopleCount_v3'; // 更新快取鍵
  var cached = cache.get(cacheKey);

  if (cached) {
    return JSON.parse(cached);
  }

  var allPeople = new Set();
  var details = [];
  var total = 0;

  // 遍歷所有倉別
  for (var warehouseKey in WAREHOUSE_IDS) {
    try {
      var ss = SpreadsheetApp.openById(WAREHOUSE_IDS[warehouseKey]);
      var sheetNames = getSheetNames_(WAREHOUSE_IDS[warehouseKey]);

      // 尋找所有班表分頁（名稱包含「班表」）
      var scheduleSheets = [];
      for (var i = 0; i < sheetNames.length; i++) {
        if (sheetNames[i].indexOf('班表') >= 0) {
          scheduleSheets.push(sheetNames[i]);
        }
      }

      if (scheduleSheets.length === 0) {
        details.push({
          warehouse: warehouseKey,
          month: '無班表',
          count: 0,
          leaveCount: 0
        });
        continue;
      }

      // 處理每個班表分頁
      for (var j = 0; j < scheduleSheets.length; j++) {
        var scheduleSheetName = scheduleSheets[j];
        var sh = ss.getSheetByName(scheduleSheetName);
        if (!sh) continue;

        var lastRow = sh.getLastRow();
        var lastCol = sh.getLastColumn();
        if (lastRow < 2 || lastCol < 1) continue;

        // 讀取資料
        var data = readSheetToPayload_(sh, lastRow, lastCol);
        var headers = data.headers;
        var rows = data.rows;
        var nameCol = findNameCol_(headers);

        if (nameCol < 0) continue;

        // 找出日期欄位
        var dateCols = data.dateCols || [];

        var warehousePeople = new Set();
        var leavePeople = new Set();

        for (var k = 0; k < rows.length; k++) {
          var name = String(rows[k].v[nameCol] || '').trim();
          if (!name) continue;

          //  修正：檢查所有日期欄位中是否有「離」文字
          var isLeave = false;
          for (var d = 0; d < dateCols.length; d++) {
            var cellValue = String(rows[k].v[dateCols[d]] || '').trim();
            // 檢查是否包含「離」字
            if (cellValue.indexOf('離') >= 0) {
              isLeave = true;
              break;
            }
          }

          //  修正：檢查其他欄位（非日期欄位）是否包含「離」字
          if (!isLeave) {
            for (var col = 0; col < rows[k].v.length; col++) {
              // 跳過日期欄位（已經檢查過）
              if (dateCols.indexOf(col) >= 0) continue;

              var otherCellValue = String(rows[k].v[col] || '').trim();
              if (otherCellValue.indexOf('離') >= 0) {
                isLeave = true;
                break;
              }
            }
          }

          if (isLeave) {
            leavePeople.add(name);
          } else {
            warehousePeople.add(name);
          }
          allPeople.add(warehouseKey + '_' + name); // 加入倉別前綴避免跨倉重複
        }

        // 提取月份資訊（從分頁名稱）
        var month = '其他月份';
        var sheetNameMatch = scheduleSheetName.match(/(\d{1,2})月/);
        if (sheetNameMatch) {
          month = sheetNameMatch[1] + '月';
        } else if (scheduleSheetName.indexOf('班表') >= 0) {
          // 如果沒有月份資訊，使用分頁名稱
          month = scheduleSheetName.replace('班表', '').trim() || '班表';
        }

        details.push({
          warehouse: warehouseKey,
          month: month,
          count: warehousePeople.size + leavePeople.size, // 總人數（含離職）
          leaveCount: leavePeople.size,
          activeCount: warehousePeople.size
        });
      }

    } catch (e) {
      console.error('Error processing warehouse ' + warehouseKey + ': ' + e.toString());
      details.push({
        warehouse: warehouseKey,
        month: '錯誤',
        count: 0,
        leaveCount: 0,
        error: e.toString()
      });
    }
  }

  total = allPeople.size;

  var result = {
    total: total,
    details: details
  };

  // 快取 5 分鐘
  cache.put(cacheKey, JSON.stringify(result), 300);

  return result;
}

/**
 * 取得當前分頁的人數統計（分頁人數與離職人數）
 *  修正：只統計當前分頁，而不是所有倉別
 */
function getCurrentSheetPeopleCount(sheetName, spreadsheetId) {
  try {
    var ss = SpreadsheetApp.openById(spreadsheetId);
    var sh = ss.getSheetByName(sheetName);
    if (!sh) {
      return { total: 0, leave: 0, error: '找不到分頁' };
    }

    var lastRow = sh.getLastRow();
    var lastCol = sh.getLastColumn();
    if (lastRow < 2 || lastCol < 1) {
      return { total: 0, leave: 0 };
    }

    // 讀取資料
    var data = readSheetToPayload_(sh, lastRow, lastCol);
    var headers = data.headers;
    var rows = data.rows;
    var nameCol = findNameCol_(headers);

    if (nameCol < 0) {
      return { total: 0, leave: 0, error: '找不到姓名欄位' };
    }

    var peopleSet = new Set();
    var leaveSet = new Set();

    for (var i = 0; i < rows.length; i++) {
      var name = String(rows[i].v[nameCol] || '').trim();
      if (!name) continue;

      //  檢查是否離職：檢查該行所有欄位是否包含「離」字
      var isLeave = false;

      // 檢查所有欄位
      for (var col = 0; col < rows[i].v.length; col++) {
        var cellValue = String(rows[i].v[col] || '').trim();
        if (cellValue.indexOf('離') >= 0) {
          isLeave = true;
          break;
        }
      }

      if (isLeave) {
        leaveSet.add(name);
      } else {
        peopleSet.add(name);
      }
    }

    var totalPeople = peopleSet.size + leaveSet.size;

    return {
      total: totalPeople,
      leave: leaveSet.size,
      active: peopleSet.size,
      success: true
    };

  } catch (e) {
    return { total: 0, leave: 0, error: e.toString() };
  }
}
