{\rtf1\ansi\ansicpg950\cocoartf2867
\cocoatextscaling0\cocoaplatform0{\fonttbl\f0\fswiss\fcharset0 Helvetica;}
{\colortbl;\red255\green255\blue255;}
{\*\expandedcolortbl;;}
\paperw11900\paperh16840\margl1440\margr1440\vieww11520\viewh8400\viewkind0
\pard\tx720\tx1440\tx2160\tx2880\tx3600\tx4320\tx5040\tx5760\tx6480\tx7200\tx7920\tx8640\pardirnatural\partightenfactor0

\f0\fs24 \cf0 <!DOCTYPE html>\
<html lang="zh-Hant">\
<head>\
  <meta charset="UTF-8" />\
  <meta name="viewport" content="width=device-width,initial-scale=1" />\
  <title>\uc0\u23439 \u30427 \u37239 \u28558 \u34920  - \u30331 \u20837 </title>\
\
  <!-- jQuery + DataTables -->\
  <script src="https://code.jquery.com/jquery-3.7.1.min.js" crossorigin="anonymous"></script>\
  <link rel="stylesheet" href="https://cdn.datatables.net/2.3.4/css/dataTables.dataTables.min.css">\
  <script src="https://cdn.datatables.net/2.3.4/js/dataTables.min.js"></script>\
\
  <!-- FixedColumns\uc0\u65288 \u20941 \u32080 \u31383 \u26684 \u65289  -->\
  <link rel="stylesheet" href="https://cdn.datatables.net/fixedcolumns/5.0.0/css/fixedColumns.dataTables.min.css">\
  <script src="https://cdn.datatables.net/fixedcolumns/5.0.0/js/dataTables.fixedColumns.min.js"></script>\
\
  <!-- Buttons \uc0\u21295 \u20986  -->\
  <link rel="stylesheet" href="https://cdn.datatables.net/buttons/3.0.2/css/buttons.dataTables.min.css">\
  <script src="https://cdn.datatables.net/buttons/3.0.2/js/dataTables.buttons.min.js"></script>\
  <script src="https://cdn.datatables.net/buttons/3.0.2/js/buttons.html5.min.js"></script>\
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>\
\
  <!-- \uc0\u19979 \u36617  PNG \u29992 \u65288 \u21934 \u20154 \u20551 \u21029 \u32113 \u35336  / \u20986 \u21220 \u29575 \u32113 \u35336 \u65289  -->\
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>\
\
  <style>\
    /* ===== \uc0\u31934 \u32654 \u29694 \u20195 \u39080 \u26684 \u65288 \u20445 \u30041 \u21407 \u26412 \u24213 \u33394 \u65289  ===== */\
    :root \{\
      --bg: #f4f2f0;\
      --bg-soft: #f0ebe6;\
      --bg-strong: #e4dfd7;\
      --primary: #5d7b93;\
      --primary-dark: #4a6378;\
      --primary-light: #8ca2b8;\
      --accent: #c9a982;\
      --accent-soft: #e8d9c5;\
      --accent-dark: #b8945e;\
      --border: #d4cec6;\
      --border-light: #e8e3dc;\
      --text-main: #2c3e50;\
      --text-muted: #7b8a8b;\
      --text-light: #95a5a6;\
      --table-header: #e9e5de;\
      --table-row-alt: #f8f6f2;\
      --sat: #e8f4f8;\
      --sun: #f8f0e8;\
      --success: #27ae60;\
      --info: #3498db;\
      --warning: #f39c12;\
      --danger: #e74c3c;\
    \}\
\
    * \{ \
      box-sizing: border-box;\
      margin: 0;\
      padding: 0;\
    \}\
\
    html, body \{\
      height: 100%;\
      font-family: "PingFang TC", "Microsoft JhengHei", "Segoe UI", system-ui, -apple-system, sans-serif;\
      color: var(--text-main);\
      background: var(--bg);\
      line-height: 1.5;\
    \}\
\
    /* ===== \uc0\u30331 \u20837 \u38913  ===== */\
    .login-page \{\
      min-height: 100vh;\
      display: flex;\
      align-items: center;\
      justify-content: center;\
      background: linear-gradient(135deg, rgba(93, 123, 147, 0.9), rgba(74, 99, 120, 0.9));\
      padding: 20px;\
    \}\
\
    /* \uc0\u9989  \u30331 \u20837 \u21345 \u29255 \u65306 \u20445 \u25345 \u27491 \u26041 \u24418 \u35222 \u35258 \u65292 \u20294 \u36991 \u20813 \u22266 \u23450 \u39640 \u24230 \u35009 \u20999 \u25353 \u37397  */\
    .login-panel \{\
      width: 520px;\
      min-height: 420px;   /* \uc0\u9989  \u25913  min-height\u65292 \u36991 \u20813 \u20839 \u23481 \u34987 \u35009 \u20999  */\
      height: auto;        /* \uc0\u9989  \u35731 \u20839 \u23481 \u21487 \u25744 \u38283 \u65292 \u30906 \u20445 \u30331 \u20837 \u25353 \u37397 \u23436 \u25972 \u39023 \u31034  */\
      background: rgba(240, 240, 240, 0.95);\
      border-radius: 0px;\
      padding: 40px;\
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.25),\
                  0 8px 16px rgba(0, 0, 0, 0.15);\
      backdrop-filter: blur(10px);\
      border: 1px solid rgba(255, 255, 255, 0.4);\
      transition: transform 0.3s ease, box-shadow 0.3s ease;\
      display: flex;\
      flex-direction: column;\
      justify-content: center;\
\
      /* \uc0\u9989  \u26032 \u22686 \u65306 \u35731 \u30331 \u20837 \u35352 \u25014 \u28014 \u21205 \u26694 \u21487 \u20197 \u29992  absolute \u23450 \u20301 \u22312 \u21345 \u29255 \u20839  */\
      position: relative;\
    \}\
\
    .login-panel:hover \{\
      transform: translateY(-4px);\
      box-shadow: 0 25px 50px rgba(0, 0, 0, 0.2),\
                  0 12px 24px rgba(0, 0, 0, 0.15);\
    \}\
\
    .login-title \{\
      font-size: 28px;\
      font-weight: 800;\
      margin: 0 0 22px; /* \uc0\u9989  \u21407 \u26412  login-sub \u22312 \u19978 \u26041 \u65292 \u31227 \u36208 \u24460 \u35036 \u22238 \u38291 \u36317  */\
      color: #333333;\
      letter-spacing: -0.5px;\
      text-align: center;\
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);\
    \}\
\
    /* \uc0\u9989  \u22995 \u21517 /\u29983 \u26085 \u21516 \u19968 \u21015 \u21312 \u22602 \u65288 \u25163 \u27231 \u33258 \u21205 \u35722 \u19978 \u19979 \u65289  */\
    .login-fields-row \{\
      display: flex;\
      flex-direction: column; /* \uc0\u9989  \u27704 \u36960 \u19978 \u19979 \u22534 \u30090  */\
      gap: 16px;\
      margin-bottom: 8px;\
    \}\
\
    .login-fields-row .login-field \{\
      flex: 1;\
      margin-bottom: 0; /* \uc0\u9989  \u36991 \u20813 \u27599 \u20491 \u27396 \u20301 \u20877 \u22810 \u19968 \u27573 \u24213 \u37096 \u31354 \u38291  */\
    \}\
\
    .login-field \{\
      margin-bottom: 20px;\
    \}\
\
    .login-field label \{\
      display: block;\
      font-size: 13px;\
      font-weight: 600;\
      margin-bottom: 8px;\
      color: #444444;\
      text-transform: uppercase;\
      letter-spacing: 0.5px;\
    \}\
\
    .login-field input \{\
      width: 100%;\
      padding: 14px 16px;\
      border: 2px solid rgba(212, 206, 198, 0.8);\
      border-radius: 8px;\
      background: #ffffff;\
      font-size: 15px;\
      font-family: inherit;\
      transition: all 0.3s ease;\
      outline: none;\
      color: #333333;\
    \}\
\
    .login-field input:focus \{\
      border-color: var(--primary);\
      box-shadow: 0 0 0 3px rgba(93, 123, 147, 0.1);\
    \}\
\
    .login-field input::placeholder \{\
      color: #999999;\
    \}\
\
    /* \uc0\u9989  \u30331 \u20837 \u35352 \u25014 \u65306 \u25913 \u28858 \u12300 \u40670 \u36664 \u20837 \u26694 \u25165 \u20986 \u29694 \u12301 \u30340 \u28014 \u21205 \u21205 \u24907 \u26694 \u65288 \u20173 \u38480 \u26412 \u27231  localStorage\u65289  */\
    .login-history \{\
      position: absolute;\
      z-index: 50;\
      padding: 12px 12px 10px;\
      border-radius: 10px;\
      background: rgba(255, 255, 255, 0.92);\
      border: 1px solid rgba(212, 206, 198, 0.85);\
      box-shadow: 0 16px 36px rgba(0,0,0,0.14);\
      display: none; /* \uc0\u38928 \u35373 \u19981 \u39023 \u31034 \u65306 \u40670 \u36664 \u20837 \u26694 \u25165 \u39023 \u31034  */\
      max-height: 240px;\
      overflow: auto;\
      backdrop-filter: blur(8px);\
    \}\
    .login-history-title \{\
      font-size: 12px;\
      font-weight: 800;\
      color: #444;\
      margin-bottom: 8px;\
      letter-spacing: 0.2px;\
      display: flex;\
      align-items: center;\
      justify-content: space-between;\
      gap: 8px;\
    \}\
    .login-history-title::before \{\
      content: '\uc0\u55358 \u56800 ';\
      font-size: 14px;\
      opacity: 0.9;\
      margin-right: 6px;\
    \}\
    .login-history-list \{\
      display: flex;\
      flex-wrap: wrap;\
      gap: 8px;\
    \}\
    .login-chip \{\
      display: inline-flex;\
      align-items: center;\
      gap: 8px;\
      padding: 8px 10px;\
      border-radius: 999px;\
      border: 1px solid rgba(212, 206, 198, 0.9);\
      background: #ffffff;\
      cursor: pointer;\
      user-select: none;\
      transition: transform 0.15s ease, box-shadow 0.2s ease, border-color 0.2s ease;\
      font-size: 12px;\
      color: #333;\
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);\
      outline: none;\
    \}\
    .login-chip:hover \{\
      transform: translateY(-1px);\
      border-color: rgba(93, 123, 147, 0.6);\
      box-shadow: 0 6px 16px rgba(0,0,0,0.08);\
    \}\
    .login-chip .nm \{ font-weight: 800; \}\
    .login-chip .bd \{ font-weight: 700; color: #666; \}\
    .login-history-actions \{\
      margin-top: 8px;\
      display: flex;\
      justify-content: flex-end;\
    \}\
    .login-history-clear \{\
      padding: 8px 12px;\
      font-size: 12px;\
      border-radius: 8px;\
      border: 1px solid rgba(212, 206, 198, 0.9);\
      background: rgba(240, 240, 240, 0.7);\
      cursor: pointer;\
      font-weight: 700;\
      color: #444;\
      transition: all 0.2s ease;\
    \}\
    .login-history-clear:hover \{\
      background: rgba(240, 240, 240, 1);\
      transform: translateY(-1px);\
    \}\
\
    .login-btn \{\
      width: 100%;\
      margin-top: 18px;\
      padding: 15px 0;\
      border: none;\
      border-radius: 8px;\
      background: linear-gradient(135deg, var(--primary), var(--primary-dark));\
      color: white;\
      font-weight: 700;\
      font-size: 15px;\
      cursor: pointer;\
      letter-spacing: 1px;\
      transition: all 0.3s ease;\
      position: relative;\
      overflow: hidden;\
      z-index: 2;\
    \}\
\
    .login-btn:hover:not(:disabled) \{\
      transform: translateY(-2px);\
      box-shadow: 0 8px 20px rgba(93, 123, 147, 0.3);\
    \}\
\
    .login-btn:active:not(:disabled) \{\
      transform: translateY(0);\
    \}\
\
    .login-btn:disabled \{\
      opacity: 0.6;\
      cursor: not-allowed;\
    \}\
\
    .login-btn::after \{\
      content: '';\
      position: absolute;\
      top: 0;\
      left: -100%;\
      width: 100%;\
      height: 100%;\
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);\
      transition: left 0.5s ease;\
    \}\
\
    .login-btn:hover::after \{\
      left: 100%;\
    \}\
\
    /* \uc0\u9989  \u25351 \u31034 \u25991 \u23383 \u31227 \u21040 \u30331 \u20837 \u25353 \u37397 \u19979 \u26041 \u65292 2\u21015 \u39023 \u31034  */\
    .login-tip \{\
      font-size: 13px;\
      color: #666666;\
      margin-top: 12px;\
      line-height: 1.6;\
      text-align: center;\
    \}\
\
    /* \uc0\u9989  \u37679 \u35492 \u35338 \u24687 \u65306 \u31354 \u30333 \u26178 \u19981 \u39023 \u31034 \u65288 \u36991 \u20813 \u20308 \u39640 \u24230 /\u36974 \u25803 \u25353 \u37397 \u65289  */\
    .login-error \{\
      margin-top: 16px;\
      padding: 12px 16px;\
      background: rgba(231, 76, 60, 0.1);\
      border: 1px solid rgba(231, 76, 60, 0.2);\
      border-radius: 8px;\
      font-size: 13px;\
      color: var(--danger);\
      text-align: center;\
      animation: slideIn 0.3s ease;\
      max-height: 60px;\
      overflow: auto;\
    \}\
    .login-error:empty \{\
      display: none;      /* \uc0\u9989  \u27794 \u35338 \u24687 \u23601 \u19981 \u39023 \u31034 \u20063 \u19981 \u20308 \u20301  */\
      margin-top: 0;\
      padding: 0;\
      border: 0;\
    \}\
\
    @keyframes slideIn \{\
      from \{\
        opacity: 0;\
        transform: translateY(-10px);\
      \}\
      to \{\
        opacity: 1;\
        transform: translateY(0);\
      \}\
    \}\
\
    /* ===== \uc0\u20027 \u30059 \u38754  ===== */\
    .app-page \{\
      display: none;\
      min-height: 100vh;\
      background: var(--bg);\
    \}\
\
    .appbar \{\
      background: linear-gradient(135deg, var(--primary-dark), var(--primary));\
      padding: 16px 32px;\
      display: flex;\
      align-items: center;\
      justify-content: space-between;\
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);\
      position: relative;\
      overflow: hidden;\
    \}\
\
    .appbar::before \{\
      content: '';\
      position: absolute;\
      top: 0;\
      left: 0;\
      right: 0;\
      bottom: 0;\
      background: linear-gradient(45deg, transparent 30%, rgba(255,255,255,0.1) 50%, transparent 70%);\
      animation: shimmer 3s infinite linear;\
    \}\
\
    @keyframes shimmer \{\
      0% \{ transform: translateX(-100%); \}\
      100% \{ transform: translateX(100%); \}\
    \}\
\
    .brand \{\
      display: flex;\
      align-items: center;\
      gap: 12px;\
      position: relative;\
      z-index: 1;\
    \}\
\
    .brand-icon \{\
      width: 36px;\
      height: 36px;\
      background: rgba(255, 255, 255, 0.2);\
      border-radius: 10px;\
      display: flex;\
      align-items: center;\
      justify-content: center;\
      font-size: 20px;\
      color: white;\
    \}\
\
    .brand-text \{\
      display: flex;\
      flex-direction: column;\
    \}\
\
    .brand-main \{\
      font-size: 18px;\
      font-weight: 700;\
      color: white;\
      letter-spacing: -0.5px;\
    \}\
\
    .brand-sub \{\
      font-size: 12px;\
      color: rgba(255, 255, 255, 0.85);\
      margin-top: 2px;\
    \}\
\
    .user-label \{\
      font-size: 14px;\
      color: rgba(255, 255, 255, 0.9);\
      display: flex;\
      align-items: center;\
      gap: 8px;\
      position: relative;\
      z-index: 1;\
    \}\
\
    .user-name-display \{\
      font-weight: 700;\
      color: white;\
      margin: 0 4px;\
    \}\
\
    /* \uc0\u55357 \u56633  \u30331 \u20986 \u25353 \u37397 \u27171 \u24335  */\
    .logout-btn \{\
      margin-left: 8px;\
      padding: 8px 16px;\
      font-size: 13px;\
      border-radius: 8px;\
      border: 1px solid rgba(255, 255, 255, 0.3);\
      background: rgba(255, 255, 255, 0.15);\
      color: white;\
      cursor: pointer;\
      transition: all 0.3s ease;\
      font-weight: 600;\
      letter-spacing: 0.5px;\
    \}\
\
    .logout-btn:hover \{\
      background: rgba(255, 255, 255, 0.25);\
      transform: translateY(-2px);\
    \}\
\
    .app-main \{\
      max-width: 1400px;\
      margin: 0 auto;\
      padding: 24px;\
    \}\
\
    /* KPI \uc0\u21015  */\
    .kpi-row \{\
      display: grid;\
      grid-template-columns: repeat(5, minmax(0, 1fr));\
      gap: 16px;\
      margin-bottom: 24px;\
    \}\
\
    .kpi \{\
      background: white;\
      border-radius: 12px;\
      padding: 20px;\
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.08);\
      border: 1px solid var(--border-light);\
      transition: all 0.3s ease;\
      position: relative;\
      overflow: hidden;\
    \}\
\
    .kpi:hover \{\
      transform: translateY(-4px);\
      box-shadow: 0 12px 30px rgba(0, 0, 0, 0.12);\
    \}\
\
    .kpi::before \{\
      content: '';\
      position: absolute;\
      top: 0;\
      left: 0;\
      right: 0;\
      height: 4px;\
      background: linear-gradient(90deg, var(--primary), var(--accent));\
    \}\
\
    .kpi:nth-child(1)::before \{ background: linear-gradient(90deg, var(--primary), var(--primary-light)); \}\
    .kpi:nth-child(2)::before \{ background: linear-gradient(90deg, var(--info), #5dade2); \}\
    .kpi:nth-child(3)::before \{ background: linear-gradient(90deg, var(--success), #58d68d); \}\
    .kpi:nth-child(4)::before \{ background: linear-gradient(90deg, var(--warning), #f8c471); \}\
    .kpi:nth-child(5)::before \{ background: linear-gradient(90deg, var(--accent), var(--accent-dark)); \}\
\
    .kpi-label \{\
      font-size: 12px;\
      text-transform: uppercase;\
      letter-spacing: 1px;\
      color: var(--text-muted);\
      margin-bottom: 8px;\
      font-weight: 600;\
      display: flex;\
      align-items: center;\
      gap: 6px;\
    \}\
\
    .kpi-label::before \{\
      content: '';\
      display: inline-block;\
      width: 8px;\
      height: 8px;\
      border-radius: 50%;\
      background: currentColor;\
      opacity: 0.6;\
    \}\
\
    .kpi-value \{\
      font-size: 32px;\
      font-weight: 800;\
      margin: 4px 0;\
      color: var(--text-main);\
      line-height: 1;\
    \}\
\
    .kpi-foot \{\
      margin-top: 8px;\
      font-size: 12px;\
      color: var(--text-light);\
      line-height: 1.4;\
    \}\
\
    .kpi-note \{\
      font-size: 13px;\
      line-height: 1.5;\
      color: var(--text-muted);\
    \}\
\
    /* \uc0\u24037 \u20855 \u21015  */\
    .toolbar \{\
      display: flex;\
      flex-wrap: wrap;\
      align-items: center;\
      gap: 12px;\
      margin-bottom: 24px;\
      background: white;\
      border-radius: 12px;\
      padding: 20px;\
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.08);\
      border: 1px solid var(--border-light);\
    \}\
\
    .toolbar label \{\
      font-size: 13px;\
      font-weight: 600;\
      color: var(--text-main);\
      display: flex;\
      align-items: center;\
      gap: 8px;\
    \}\
\
    select, button, input[type="text"] \{\
      padding: 10px 14px;\
      border: 2px solid var(--border-light);\
      border-radius: 8px;\
      background: white;\
      font-size: 14px;\
      font-family: inherit;\
      outline: none;\
      transition: all 0.3s ease;\
    \}\
\
    select:focus, button:focus, input[type="text"]:focus \{\
      border-color: var(--primary);\
      box-shadow: 0 0 0 3px rgba(93, 123, 147, 0.1);\
    \}\
\
    .btn-secondary \{\
      background: linear-gradient(135deg, var(--accent-soft), var(--accent));\
      border: none;\
      color: var(--text-main);\
      font-weight: 600;\
      cursor: pointer;\
      padding: 10px 20px;\
      min-width: 120px;\
    \}\
\
    /* \uc0\u9989  \u38283 \u21855 \u35430 \u31639 \u34920 \u65306 \u20351 \u29992  a[target=_blank] \u36991 \u20813  popup blocker */\
    a.btn-secondary\{\
      text-decoration: none;\
      display: inline-flex;\
      align-items: center;\
      justify-content: center;\
    \}\
    a.btn-secondary[aria-disabled="true"]\{\
      pointer-events: none;\
      opacity: 0.65;\
    \}\
\
    .btn-secondary:hover \{\
      transform: translateY(-2px);\
      box-shadow: 0 6px 16px rgba(201, 169, 130, 0.3);\
    \}\
\
    /* \uc0\u9989  \u38283 \u21855 \u21508 \u20489 \u35430 \u31639 \u34920 \u65306 \u20489 \u21029 \u25353 \u37397 \u65288 \u40670 \u19968 \u19979 \u30452 \u25509 \u38283 \u26032 \u20998 \u38913 \u65292 \u19981 \u38656 \u31561 \u24453 \u35712 \u21462 \u65289  */\
    .open-wh-btns\{\
      display: flex;\
      flex-wrap: wrap;\
      gap: 8px;\
    \}\
    .open-wh-btns .open-wh-btn\{\
      min-width: 72px;   /* \uc0\u35206 \u23531  .btn-secondary \u30340  min-width:120 */\
      padding: 10px 14px;\
      line-height: 1.1;\
    \}\
    .msg-inline \{\
      font-size: 14px;\
      font-weight: 600;\
      color: var(--primary);\
      display: flex;\
      align-items: center;\
      gap: 8px;\
      margin-left: auto;\
    \}\
\
    .msg-inline-icon \{\
      font-size: 18px;\
      animation: spin 2s linear infinite;\
    \}\
\
    @keyframes spin \{\
      from \{ transform: rotate(0deg); \}\
      to \{ transform: rotate(360deg); \}\
    \}\
\
    /* \uc0\u34920 \u26684 \u22806 \u26694  */\
    .table-wrap \{\
      border-radius: 12px;\
      background: white;\
      padding: 4px;\
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.08);\
      border: 1px solid var(--border-light);\
      overflow: hidden;\
      margin-bottom: 24px;\
    \}\
\
    table.dataTable thead th \{\
      background: linear-gradient(180deg, var(--table-header), #e1dbd1);\
      border-bottom: 2px solid var(--border);\
      padding: 14px 12px !important;\
      font-weight: 700;\
      color: var(--text-main);\
      text-transform: uppercase;\
      letter-spacing: 0.5px;\
      font-size: 13px;\
    \}\
\
    table.dataTable tbody td \{\
      padding: 12px !important;\
      border-bottom: 1px solid var(--border-light);\
    \}\
\
    table.dataTable tbody tr \{\
      transition: all 0.2s ease;\
    \}\
\
    table.dataTable tbody tr:hover td \{\
      background: rgba(93, 123, 147, 0.05) !important;\
      transform: scale(1.002);\
    \}\
\
    table.dataTable tbody tr:nth-child(even) td \{\
      background: var(--table-row-alt);\
    \}\
\
    .col-sat \{\
      background-color: var(--sat) !important;\
      position: relative;\
    \}\
\
    .col-sat::after \{\
      content: '\uc0\u20845 ';\
      position: absolute;\
      top: 2px;\
      right: 2px;\
      font-size: 10px;\
      color: var(--primary);\
      opacity: 0.6;\
    \}\
\
    .col-sun \{\
      background-color: var(--sun) !important;\
      position: relative;\
    \}\
\
    .col-sun::after \{\
      content: '\uc0\u26085 ';\
      position: absolute;\
      top: 2px;\
      right: 2px;\
      font-size: 10px;\
      color: var(--danger);\
      opacity: 0.6;\
    \}\
\
    /* DataTables Buttons */\
    .dt-buttons .dt-button \{\
      border-radius: 8px !important;\
      border: 2px solid var(--border-light) !important;\
      background: white !important;\
      color: var(--text-main) !important;\
      font-size: 13px !important;\
      padding: 8px 16px !important;\
      margin-left: 8px !important;\
      font-weight: 600;\
      transition: all 0.3s ease;\
    \}\
\
    .dt-buttons .dt-button:hover \{\
      background: var(--primary) !important;\
      color: white !important;\
      border-color: var(--primary) !important;\
      transform: translateY(-2px);\
    \}\
\
    /* \uc0\u20998 \u38913 \u20027 \u34920 \u26684  */\
    #tbl.dataTable \{\
      font-size: 14px;\
      border-collapse: separate;\
      border-spacing: 0;\
    \}\
\
    #tbl.dataTable thead th,\
    #tbl.dataTable tbody td \{\
      padding: 10px 12px !important;\
      line-height: 1.4;\
      border-right: 1px solid var(--border-light) !important;\
    \}\
\
    #tbl.dataTable thead th:last-child,\
    #tbl.dataTable tbody td:last-child \{\
      border-right: none !important;\
    \}\
\
    #tbl_wrapper .dt-search input \{\
      font-size: 14px;\
      padding: 10px 14px;\
      border-radius: 8px;\
      border: 2px solid var(--border-light);\
    \}\
\
    #tbl_wrapper .dt-length select \{\
      font-size: 14px;\
      padding: 8px 12px;\
      border-radius: 8px;\
      border: 2px solid var(--border-light);\
    \}\
\
    /* \uc0\u9989  \u26032 \u22686 \u65306 \u20027 \u36039 \u26009 \u34920 \u32302 \u23567 \u65288 \u21482 \u24433 \u38911  #tbl\u65292 \u19981 \u21205 \u20854 \u23427 \u32113 \u35336 \u34920 \u65289  */\
    #tbl.dataTable \{ font-size: 12.5px; \}\
    #tbl.dataTable thead th \{ padding: 9px 8px !important; font-size: 12px !important; \}\
    #tbl.dataTable tbody td \{ padding: 7px 8px !important; line-height: 1.25; \}\
    #tbl_wrapper .dt-search input \{ font-size: 13px; padding: 8px 10px; \}\
    #tbl_wrapper .dt-length select \{ font-size: 13px; padding: 6px 10px; \}\
\
    /* \uc0\u32113 \u35336 \u21312 \u22602  */\
    .stats-block \{\
      margin-top: 24px;\
      padding: 20px;\
      background: white;\
      border-radius: 12px;\
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.08);\
      border: 1px solid var(--border-light);\
    \}\
\
    .stats-header \{\
      display: flex;\
      flex-wrap: wrap;\
      justify-content: space-between;\
      align-items: flex-start;\
      gap: 12px;\
      margin-bottom: 16px;\
      padding-bottom: 16px;\
      border-bottom: 2px solid var(--border-light);\
    \}\
\
    .stats-title \{\
      font-size: 18px;\
      font-weight: 700;\
      color: var(--primary-dark);\
      display: flex;\
      align-items: center;\
      gap: 10px;\
    \}\
\
    .stats-title::before \{\
      content: '';\
      width: 4px;\
      height: 20px;\
      background: linear-gradient(180deg, var(--primary), var(--primary-dark));\
      border-radius: 2px;\
    \}\
\
    .stats-note \{\
      font-size: 13px;\
      color: var(--text-muted);\
      line-height: 1.6;\
      max-width: 600px;\
    \}\
\
    .stats-toolbar \{\
      display: flex;\
      flex-wrap: wrap;\
      align-items: center;\
      gap: 12px;\
      margin-bottom: 20px;\
      padding: 16px;\
      background: var(--bg-soft);\
      border-radius: 8px;\
    \}\
\
    .stats-inline-title \{\
      font-size: 14px;\
      font-weight: 600;\
      color: var(--text-main);\
      margin-left: auto;\
    \}\
\
    /* PNG \uc0\u21295 \u20986 \u26178 \u21482 \u20445 \u30041 \u34920 \u26684 \u21312 \u22602  */\
    .export-only-table .dt-search,\
    .export-only-table .dt-buttons,\
    .export-only-table .dt-length,\
    .export-only-table .dt-info,\
    .export-only-table .dt-paging \{\
      display: none !important;\
    \}\
\
    /* \uc0\u9989  \u20998 \u38913 \u20154 \u25976 \u33287 \u38626 \u32887 \u20154 \u25976 \u27171 \u24335  */\
    .page-stats \{\
      display: flex;\
      flex-direction: column;\
      gap: 4px;\
    \}\
\
    .page-stats-total \{\
      font-size: 24px;\
      font-weight: 700;\
      color: var(--text-main);\
    \}\
\
    .page-stats-leave \{\
      font-size: 16px;\
      font-weight: 600;\
      color: var(--danger);\
    \}\
\
    /* RWD */\
    @media (max-width: 1200px) \{\
      .kpi-row \{\
        grid-template-columns: repeat(3, minmax(0, 1fr));\
      \}\
    \}\
\
    @media (max-width: 900px) \{\
      .kpi-row \{\
        grid-template-columns: repeat(2, minmax(0, 1fr));\
      \}\
      \
      .app-main \{\
        padding: 16px;\
      \}\
      \
      .toolbar \{\
        flex-direction: column;\
        align-items: stretch;\
        gap: 16px;\
      \}\
      \
      .login-panel \{\
        width: 92px;\
        min-height: 560px;\
        padding: 30px;\
      \}\
    \}\
\
    @media (max-width: 600px) \{\
      .kpi-row \{\
        grid-template-columns: 1fr;\
      \}\
\
      .appbar \{\
        flex-direction: column;\
        gap: 16px;\
        padding: 20px 16px;\
        text-align: center;\
      \}\
      \
      .brand \{\
        flex-direction: column;\
        text-align: center;\
      \}\
      \
      .login-panel \{\
        width: 92px;\
        min-height: 560px;\
        padding: 25px;\
      \}\
      \
      .login-title \{\
        font-size: 24px;\
      \}\
\
      /* \uc0\u9989  \u25163 \u27231 \u26178 \u25913 \u25104 \u19978 \u19979 \u22534 \u30090  */\
      .login-fields-row \{\
        flex-direction: column;\
        gap: 16px;\
        margin-bottom: 6px;\
      \}\
    \}\
\
    /* \uc0\u25163 \u27231 \u27243 \u21521 \u28369 \u21205  */\
    .table-wrap\{\
      overflow-x: auto;\
      -webkit-overflow-scrolling: touch;\
      touch-action: pan-x pan-y;\
    \}\
\
    #tbl_wrapper .dt-scroll-body\{\
      overflow-x: auto !important;\
      -webkit-overflow-scrolling: touch;\
      touch-action: pan-x pan-y;\
    \}\
\
    /* \uc0\u9989  \u20462 \u27491 \u65306 \u31227 \u38500  !important\u65292 \u36991 \u20813 \u27396 \u20301 \u31721 \u36984 \u24460 \u34920 \u38957 /\u27396 \u20301 \u23532 \u24230 \u35336 \u31639 \u22833 \u21435 \u21516 \u27493  */\
    #tbl_wrapper .dt-scroll-head table,\
    #tbl_wrapper .dt-scroll-body table\{\
      width: max-content;\
    \}\
\
    /* \uc0\u9989  \u20462 \u27491 \u65306 \u31227 \u38500  !important\u65292 \u35731  DataTables \u21487 \u20197 \u22312 \u27396 \u20301 \u38577 \u34255 /\u39023 \u31034 \u24460 \u37325 \u26032 \u35336 \u31639 \u23532 \u24230  */\
    #tbl_wrapper .dt-scroll-headInner\{\
      width: max-content;\
    \}\
\
    @media (max-width: 768px)\{\
      #tbl.dataTable thead th,\
      #tbl.dataTable tbody td\{\
        min-width: 100px;\
        white-space: nowrap;\
      \}\
\
      #tbl.dataTable thead th:first-child,\
      #tbl.dataTable tbody td:first-child\{\
        min-width: 80px;\
      \}\
    \}\
\
    /* KPI \uc0\u36617 \u20837 \u21205 \u30059  */\
    .kpi-loading \{\
      display: inline-block;\
      width: 20px;\
      height: 20px;\
      border: 3px solid var(--border-light);\
      border-top-color: var(--primary);\
      border-radius: 50%;\
      animation: spin 1s linear infinite;\
      margin-left: 8px;\
    \}\
\
    /* \uc0\u20489 \u21029 \u20154 \u25976 \u26126 \u32048 \u24392 \u31383  */\
    .warehouse-details \{\
      margin-top: 8px;\
      font-size: 12px;\
      color: var(--text-muted);\
    \}\
\
    .warehouse-details span \{\
      display: inline-block;\
      margin-right: 8px;\
      margin-bottom: 4px;\
      padding: 2px 8px;\
      background: var(--bg-soft);\
      border-radius: 4px;\
      border-left: 3px solid var(--primary);\
    \}\
\
    /* \uc0\u9989  \u20445 \u38570 \u65306 KPI \u31532 3\u26684 \u65288 \u36039 \u26009 \u31558 \u25976 \u37027 \u26684 \u65289 \u25972 \u39636 \u32302 \u23567  */\
    .kpi-row .kpi:nth-child(3) .kpi-value\{\
      font-size: 18px !important;\
      line-height: 1.2 !important;\
      white-space: normal !important;\
      word-break: break-word !important;\
    \}\
  </style>\
</head>\
<body>\
\
<!-- ===== \uc0\u30331 \u20837 \u38913  ===== -->\
<div class="login-page" id="loginPage">\
  <div class="login-panel">\
    <div class="login-title">\uc0\u23439 \u30427 \u37239 \u28558 \u30331 \u20837 \u31995 \u32113 </div>\
\
    <!-- \uc0\u9989  \u22995 \u21517 /\u29983 \u26085 \u21516 \u19968 \u21015 \u21312 \u22602  -->\
    <div class="login-fields-row">\
      <div class="login-field">\
        <label for="loginName">\uc0\u22995 \u21517 </label>\
        <input id="loginName" type="text" placeholder="\uc0\u35531 \u36664 \u20837 \u23436 \u25972 \u22995 \u21517 " autocomplete="off">\
      </div>\
\
      <div class="login-field">\
        <label for="loginBirthday">\uc0\u29983 \u26085 </label>\
        <input id="loginBirthday" type="text" placeholder="\uc0\u20363 \u22914 \u65306 810101 \u25110  19810101" autocomplete="off">\
      </div>\
    </div>\
\
    <!-- \uc0\u9989  \u30331 \u20837 \u35352 \u25014 \u65306 \u28014 \u21205 \u21205 \u24907 \u26694 \u65288 \u40670 \u20219 \u19968 \u36664 \u20837 \u26694 \u25165 \u20986 \u29694 \u65289  -->\
    <div class="login-history" id="loginHistoryWrap" aria-hidden="true">\
      <div class="login-history-title">\
        <span>\uc0\u26368 \u36817 \u20351 \u29992 \u65288 \u40670 \u19968 \u19979 \u24118 \u20837 \u65289 </span>\
        <button type="button" class="login-history-clear" id="clearLoginHistory">\uc0\u28165 \u38500 \u35352 \u37636 </button>\
      </div>\
      <div class="login-history-list" id="loginHistoryList"></div>\
    </div>\
\
    <button type="button" class="login-btn" id="loginBtn">\
      <span>\uc0\u30331 \u20837 \u31995 \u32113 </span>\
    </button>\
\
    <!-- \uc0\u9989  \u25991 \u23383 \u31227 \u21040 \u30331 \u20837 \u25353 \u37397 \u19979 \u26041 \u65292 2\u21015 \u39023 \u31034  -->\
    <div class="login-tip">\uc0\u35531 \u36664 \u20837 \u22995 \u21517 \u33287 \u29983 \u26085 \u30331 \u20837 \u31995 \u32113 \u65292 <br>\u31995 \u32113 \u20677 \u26371 \u39023 \u31034 \u24744 \u30340 \u20986 \u21220 \u36039 \u26009 \u12290 </div>\
\
    <!-- \uc0\u9989  \u31354 \u30333 \u26178 \u19981 \u39023 \u31034 \u65288 CSS :empty \u25511 \u21046 \u65289  -->\
    <div class="login-error" id="loginError"></div>\
  </div>\
</div>\
\
<!-- ===== \uc0\u20027 \u30059 \u38754  ===== -->\
<div class="app-page" id="appPage">\
  <header class="appbar">\
    <div class="brand">\
      <div class="brand-icon">\uc0\u55357 \u56520 </div>\
      <div class="brand-text">\
        <div class="brand-main">\uc0\u23439 \u30427 \u37239 \u28558 \u26597 \u35426 \u31995 \u32113 \u34920 </div>\
        <div class="brand-sub" id="warehouseSub">TAO1 \uc0\u20986 \u21220 \u26597 \u35426 </div>\
      </div>\
    </div>\
    <div class="user-label">\
      <span>\uc0\u55357 \u56420  \u24050 \u30331 \u20837 \u65306 </span>\
      <span class="user-name-display" id="userDisplayName">\'97</span>\
      <button type="button" class="logout-btn" id="logoutBtn">\uc0\u30331 \u20986 \u31995 \u32113 </button>\
    </div>\
  </header>\
\
  <main class="app-main">\
    <!-- \uc0\u19978 \u26041  KPI -->\
    <div class="kpi-row">\
      <div class="kpi">\
        <div class="kpi-label">\uc0\u26597 \u35426 \u22995 \u21517 </div>\
        <div class="kpi-value" id="kpiName">\'97</div>\
        <div class="kpi-foot">\uc0\u30331 \u20837 \u24460 \u33258 \u21205 \u24118 \u20837 </div>\
      </div>\
      <div class="kpi">\
        <div class="kpi-label">\uc0\u30446 \u21069 \u20998 \u38913 </div>\
        <div class="kpi-value" id="kpiSheet">\'97</div>\
        <div class="kpi-foot">\uc0\u19968 \u33324 \u24115 \u34399 \u39023 \u31034 \u20998 \u38913 \u21517 \u31281 \u65307 \u31649 \u29702 \u32773 \u39023 \u31034 \u20154 \u25976 /\u31558 \u25976 </div>\
      </div>\
      <div class="kpi">\
        <div class="kpi-label">\uc0\u36039 \u26009 \u31558 \u25976 </div>\
        <div class="kpi-value" id="kpiCount">\'97</div>\
        <div class="kpi-foot">\uc0\u19968 \u33324 \u24115 \u34399 \u28858 \u36039 \u26009 \u21015 \u25976 \u65307 \u31649 \u29702 \u32773 \u20778 \u20808 \u39023 \u31034 \u37096 \u38272 \u25976 </div>\
      </div>\
      <!-- \uc0\u9989  \u20462 \u25913 \u65306 \u20489 \u21029 \u32317 \u20154 \u25976 \u25913 \u28858 \u35442 \u20998 \u38913 \u20154 \u25976 \u33287 \u38626 \u32887 \u20154 \u25976  -->\
      <div class="kpi">\
        <div class="kpi-label">\uc0\u20998 \u38913 \u20154 \u25976  / \u38626 \u32887 \u20154 \u25976 </div>\
        <div class="page-stats" id="pageStats">\
          <div class="page-stats-total" id="pageTotal">\'97</div>\
          <div class="page-stats-leave" id="pageLeave">\'97</div>\
        </div>\
        <div class="kpi-foot">\uc0\u35442 \u20998 \u38913 \u32317 \u20154 \u25976 \u65288 \u38626 \u32887 \u20154 \u25976 \u65289 </div>\
      </div>\
      <div class="kpi">\
        <div class="kpi-label">\uc0\u31995 \u32113 \u35498 \u26126 </div>\
        <div class="kpi-note">\
          \uc0\u26412 \u31995 \u32113 \u20677 \u39023 \u31034 \u30331 \u20837 \u27402 \u38480 \u21487 \u35211 \u30340 \u36039 \u26009 \u65306 \u19968 \u33324 \u24115 \u34399 \u21482 \u30475 \u33258 \u24049 \u65292 \u31649 \u29702 \u32773 \u21487 \u26597 \u30475 \u20840 \u37096 \u36039 \u26009 \u12290 \
        </div>\
      </div>\
    </div>\
\
    <!-- \uc0\u24037 \u20855 \u21015  -->\
    <div class="toolbar">\
      <label id="warehouseBlock" style="display:none;">\
        \uc0\u20489 \u21029 \u65306 \
        <select id="warehouseSelect">\
          <? for (var i = 0; i < whKeys.length; i++) \{ var wk = whKeys[i]; ?>\
            <option value="<?= wk ?>" <?= wk === whKey ? 'selected' : '' ?>><?= wk ?></option>\
          <? \} ?>\
        </select>\
      </label>\
\
      <label id="openSheetBlock" style="display:none;">\
        \uc0\u38283 \u21855 \u21508 \u20489 \u35430 \u31639 \u34920 \u65306 \
        <span class="open-wh-btns" id="openWhBtns">\
          <? for (var i = 0; i < whKeys.length; i++) \{ var wk = whKeys[i]; var sid = (whIds && whIds[wk]) ? whIds[wk] : ''; ?>\
            <a class="btn-secondary open-wh-btn" href="https://docs.google.com/spreadsheets/d/<?= sid ?>/edit" target="_blank" rel="noopener noreferrer"><?= wk ?></a>\
          <? \} ?>\
        </span>\
      </label>\
\
\
      <label>\
        \uc0\u20998 \u38913 \u65306 \
        <select id="sheetSelect">\
          <? for (var i = 0; i < sheetNames.length; i++) \{ var nm = sheetNames[i]; ?>\
            <option value="<?= nm ?>" <?= nm === sheetName ? 'selected' : '' ?>><?= nm ?></option>\
          <? \} ?>\
        </select>\
      </label>\
\
      <button type="button" class="btn-secondary" id="reloadBtn">\
        \uc0\u55357 \u56580  \u37325 \u26032 \u36617 \u20837 \
      </button>\
\
      <label>\
        \uc0\u20941 \u32080 \u27396 \u20301 \u65306 \
        <select id="freezeStart"></select>\
        \uc0\u65374 \
        <select id="freezeEnd"></select>\
      </label>\
      <button type="button" class="btn-secondary" id="applyFreeze">\uc0\u22871 \u29992 \u20941 \u32080 </button>\
      <button type="button" id="resetFreeze">\uc0\u21462 \u28040 \u20941 \u32080 </button>\
\
      <span class="msg-inline" id="loadingMsg"></span>\
    </div>\
\
    <!-- \uc0\u36039 \u26009 \u34920  -->\
    <div class="table-wrap">\
      <table id="tbl" class="display nowrap" style="width:100%"></table>\
    </div>\
\
    <!-- \uc0\u21934 \u20154 \u20551 \u21029 \u27396 \u20301 \u31721 \u36984  -->\
    <section class="stats-block" id="leaveFilterBlock">\
      <div class="stats-header">\
        <div class="stats-title">\uc0\u21934 \u20154 \u20551 \u21029 \u27396 \u20301 \u31721 \u36984 </div>\
        <div class="stats-note">\uc0\u24478 \u30446 \u21069 \u20998 \u38913 \u20013 \u27492 \u22995 \u21517 \u30340 \u36039 \u26009 \u65292 \u20381 \u20551 \u21029 \u39023 \u31034 \u23565 \u25033 \u30340 \u26085 \u26399 \u27396 \u20301 \u12290 </div>\
      </div>\
      <div class="stats-toolbar">\
        <label>\
          \uc0\u20551 \u21029 \u65306 \
          <select id="leaveFilterSelect">\
            <option value="">\uc0\u20840 \u37096 \u26085 \u26399 </option>\
          </select>\
        </label>\
        <button type="button" class="btn-secondary" id="clearLeaveFilter">\uc0\u28165 \u38500 \u20551 \u21029 \u31721 \u36984 </button>\
      </div>\
    </section>\
\
    <!-- \uc0\u31649 \u29702 \u32773 \u22995 \u21517 \u36984 \u25799  -->\
    <section class="stats-block" id="adminNameBlock" style="display:none;">\
      <div class="stats-header">\
        <div class="stats-title">\uc0\u31649 \u29702 \u32773 \u22995 \u21517 \u36984 \u25799 </div>\
        <div class="stats-note">\
          \uc0\u20677 \u31649 \u29702 \u32773 \u30331 \u20837 \u26178 \u26377 \u25928 \u65292 \u35531 \u36664 \u20837 \u35201 \u32113 \u35336 \u30340 \u22995 \u21517 \u65292 \u22871 \u29992 \u26044 \u19979 \u26041 \u12300 \u21934 \u20154 \u20551 \u21029 \u32113 \u35336 \u12301 \u33287 \u12300 \u21934 \u20154 \u20986 \u21220 \u29575 \u32113 \u35336 \u12301 \u12290 \
        </div>\
      </div>\
      <div class="stats-toolbar">\
        <label>\
          \uc0\u22995 \u21517 \u65306 \
          <input type="text" id="statNameInput" placeholder="\uc0\u35531 \u36664 \u20837 \u35201 \u32113 \u35336 \u30340 \u22995 \u21517 ">\
        </label>\
        <button type="button" class="btn-secondary" id="clearStatNameBtn">\uc0\u28165 \u38500 \u22995 \u21517 </button>\
      </div>\
    </section>\
\
    <!-- \uc0\u21934 \u20154 \u20551 \u21029 \u32113 \u35336  -->\
    <section class="stats-block" id="singleStatBlock">\
      <div class="stats-header">\
        <div class="stats-title">\uc0\u21934 \u20154 \u20551 \u21029 \u32113 \u35336 </div>\
        <div class="stats-note">\
          \uc0\u19968 \u33324 \u24115 \u34399 \u65306 \u20351 \u29992 \u30331 \u20837 \u22995 \u21517 \u32113 \u35336 \
        </div>\
      </div>\
      <div class="stats-toolbar">\
        <button type="button" class="btn-secondary" id="buildSingleStat">\uc0\u29986 \u29983 \u20551 \u21029 \u32113 \u35336 </button>\
        <button type="button" id="clearSingleStat">\uc0\u28165 \u38500 </button>\
        <span class="stats-inline-title">\uc0\u27161 \u38988 \u65306 <span id="singleStatTitle">\'97</span></span>\
      </div>\
      <div class="table-wrap" id="singleStatWrap">\
        <div class="stats-inline-title" id="singleStatCaption">\'97</div>\
        <table id="singleStatTbl" class="display nowrap" style="width:100%"></table>\
      </div>\
    </section>\
\
    <!-- \uc0\u21934 \u20154 \u20986 \u21220 \u29575 \u32113 \u35336  -->\
    <section class="stats-block" id="attStatBlock">\
      <div class="stats-header">\
        <div class="stats-title">\uc0\u21934 \u20154 \u20986 \u21220 \u29575 \u32113 \u35336 </div>\
        <div class="stats-note">\
          \uc0\u19968 \u33324 \u24115 \u34399 \u65306 \u20351 \u29992 \u30331 \u20837 \u22995 \u21517 \u32113 \u35336 \u12290 \u31649 \u29702 \u32773 \u65306 \u20381 \u12300 \u31649 \u29702 \u32773 \u22995 \u21517 \u36984 \u25799 \u12301 \u21312 \u22602 \u30340 \u22995 \u21517 \u32113 \u35336 \u12290 <br>\
          \uc0\u25033 \u21040 \u22825 \u25976 \u65306 \u25490 \u38500  \u20241  / \u20241 \u20551  / \u20241 \u20551 \u26085  / \u20363  / \u20363 \u20551  / \u20363 \u20241  / \u20363 \u20551 \u26085  / \u35519 \u20219  / \u35519 \u20489  / \u38626  / \u26410  / \u36681 \u27491  / \u36681 \u35657  / \u39089 \u39080  / \u20844 \u20551 \u65292 \u20854 \u39192 \u65288 \u21547 \u31354 \u30333 \u65289 \u35222 \u28858 \u25033 \u21040 \u12290 \
        </div>\
      </div>\
      <div class="stats-toolbar">\
        <label>\
          \uc0\u32113 \u35336 \u32080 \u26463 \u26085 \u65306 \
          <select id="attEndDateSelect">\
            <option value="">\uc0\u20840 \u37096 \u26085 \u26399 </option>\
          </select>\
        </label>\
        <label>\
          \uc0\u21934 \u26085 \u32113 \u35336 \u65306 \
          <select id="attSingleDateSelect">\
            <option value="">\uc0\u19981 \u25351 \u23450 </option>\
          </select>\
        </label>\
        <button type="button" class="btn-secondary" id="buildAttStat">\uc0\u29986 \u29983 \u20986 \u21220 \u29575 \u32113 \u35336 </button>\
        <button type="button" id="clearAttStat">\uc0\u28165 \u38500 </button>\
        <span class="stats-inline-title">\uc0\u27161 \u38988 \u65306 <span id="attStatTitle">\'97</span></span>\
      </div>\
      <div class="table-wrap" id="attStatWrap">\
        <table id="attStatTbl" class="display nowrap" style="width:100%"></table>\
      </div>\
    </section>\
\
    <!-- \uc0\u31649 \u29702 \u32773 \u65306 \u20840 \u21729 \u21508 \u33258 \u20986 \u21220 \u29575 \u32113 \u35336  -->\
    <section class="stats-block" id="allAttStatBlock" style="display:none;">\
      <div class="stats-header">\
        <div class="stats-title">\uc0\u20840 \u21729 \u20986 \u21220 \u29575 \u32113 \u35336 \u65288 \u31649 \u29702 \u32773 \u65289 </div>\
        <div class="stats-note">\
          \uc0\u20381 \u30446 \u21069 \u29677 \u34920 \u20998 \u38913 \u35336 \u31639 \u27599 \u20301 \u21729 \u24037 \u30340 \u25033 \u21040 /\u23526 \u21040 /\u20986 \u21220 \u29575 \u65307 \u32113 \u35336 \u31684 \u22285 \u21516 \u19978 \u26041 \u12300 \u32113 \u35336 \u32080 \u26463 \u26085 \u12301 \u12290 \
        </div>\
      </div>\
      <div class="stats-toolbar">\
        <button type="button" class="btn-secondary" id="buildAllAttStat">\uc0\u29986 \u29983 \u20840 \u21729 \u20986 \u21220 \u29575 \u32113 \u35336 </button>\
        <button type="button" id="clearAllAttStat">\uc0\u28165 \u38500 </button>\
        <span class="stats-inline-title">\uc0\u27161 \u38988 \u65306 <span id="allAttStatTitle">\'97</span></span>\
      </div>\
      <div class="table-wrap" id="allAttStatWrap">\
        <table id="allAttStatTbl" class="display nowrap" style="width:100%"></table>\
      </div>\
    </section>\
\
  </main>\
</div>\
\
<script>\
  (function () \{\
    const SHEET_INIT  = <?= JSON.stringify(sheetName || '') ?>;\
    const SHEET_NAMES = <?= JSON.stringify(sheetNames || []) ?>;\
    const BASE_URL    = '<?= ScriptApp.getService().getUrl() ?>';\
    const WH_KEY_INIT = <?= JSON.stringify(whKey || '') ?>;\
    const WH_KEYS     = <?= JSON.stringify(whKeys || []) ?>;\
    const WH_IDS      = <?= JSON.stringify(whIds || \{\}) ?>;\
\
    const loginPage   = document.getElementById('loginPage');\
    const appPage     = document.getElementById('appPage');\
\
    const loginNameInput     = document.getElementById('loginName');\
    const loginBirthdayInput = document.getElementById('loginBirthday');\
    const loginBtn           = document.getElementById('loginBtn');\
    const loginError         = document.getElementById('loginError');\
\
    // \uc0\u9989  \u30331 \u20837 \u35352 \u25014  UI\u65288 \u21205 \u24907 \u28014 \u21205 \u26694 \u65289 \
    const loginHistoryWrap = document.getElementById('loginHistoryWrap');\
    const loginHistoryList = document.getElementById('loginHistoryList');\
    const clearLoginHistoryBtn = document.getElementById('clearLoginHistory');\
\
    const userDisplayName = document.getElementById('userDisplayName');\
    const kpiName   = document.getElementById('kpiName');\
    const kpiSheet  = document.getElementById('kpiSheet');\
    const kpiCount  = document.getElementById('kpiCount');\
    const pageTotal = document.getElementById('pageTotal');\
    const pageLeave = document.getElementById('pageLeave');\
    const logoutBtn = document.getElementById('logoutBtn');\
    const warehouseSub = document.getElementById('warehouseSub');\
\
    const sheetSelect = document.getElementById('sheetSelect');\
    const reloadBtn   = document.getElementById('reloadBtn');\
    const loadingMsg  = document.getElementById('loadingMsg');\
\
    const freezeStart     = document.getElementById('freezeStart');\
    const freezeEnd       = document.getElementById('freezeEnd');\
    const applyFreezeBtn  = document.getElementById('applyFreeze');\
    const resetFreezeBtn  = document.getElementById('resetFreeze');\
\
    const leaveFilterBlock   = document.getElementById('leaveFilterBlock');\
    const leaveFilterSelect   = document.getElementById('leaveFilterSelect');\
    const clearLeaveFilterBtn = document.getElementById('clearLeaveFilter');\
\
    const adminNameBlock   = document.getElementById('adminNameBlock');\
    const statNameInput    = document.getElementById('statNameInput');\
    const clearStatNameBtn = document.getElementById('clearStatNameBtn');\
\
    const singleStatBlock   = document.getElementById('singleStatBlock');\
    const singleStatTitle   = document.getElementById('singleStatTitle');\
    const singleStatWrap    = document.getElementById('singleStatWrap');\
    const singleStatCaption = document.getElementById('singleStatCaption');\
\
    const attStatBlock        = document.getElementById('attStatBlock');\
    const attEndDateSelect    = document.getElementById('attEndDateSelect');\
    const attSingleDateSelect = document.getElementById('attSingleDateSelect');\
    const attStatTitle        = document.getElementById('attStatTitle');\
    const attStatWrap         = document.getElementById('attStatWrap');\
    const buildAttStatBtn     = document.getElementById('buildAttStat');\
    const clearAttStatBtn     = document.getElementById('clearAttStat');\
\
    const allAttStatBlock     = document.getElementById('allAttStatBlock');\
    const allAttStatTitle     = document.getElementById('allAttStatTitle');\
    const allAttStatWrap      = document.getElementById('allAttStatWrap');\
    const buildAllAttStatBtn  = document.getElementById('buildAllAttStat');\
    const clearAllAttStatBtn  = document.getElementById('clearAllAttStat');\
\
    const warehouseBlock  = document.getElementById('warehouseBlock');\
    const warehouseSelect = document.getElementById('warehouseSelect');\
\
    // \uc0\u9989  \u31649 \u29702 \u32773 \u65306 \u38283 \u21855 \u21508 \u20489  Google Sheet \u35430 \u31639 \u34920 \u65288 \u26032 \u38913 \u38754 \u65289 \
    const openSheetBlock      = document.getElementById('openSheetBlock');\
    const openWarehouseSelect = document.getElementById('openWarehouseSelect');\
    const openSheetBtn        = document.getElementById('openSheetBtn');\
\
    let loginName   = '';\
    let isAdmin     = false;\
    let statName    = '';\
    let currentSheet = SHEET_INIT;\
    let currentWarehouse = WH_KEY_INIT || '';\
    let table       = null;\
\
    let LAST = \{ headers: [], headersISO: [], rows: [], dateCols: [] \};\
    let lastPayload = null;\
    let currentFrozenLeft = 0;\
    let savedVisibilityForLeaveFilter = null;\
    let singleStatDT = null;\
    let attStatDT = null;\
    let allAttStatDT = null;\
    let ATT_DATE_LIST = [];\
\
    // \uc0\u9989  \u26032 \u22686 \u65306 \u20551 \u21029 \u31721 \u36984 \u27169 \u24335 \u65288 \u29677 \u34920 \u30697 \u38499 \u27396 \u20301  / \u20986 \u21220 \u35352 \u37636 \u21015 \u24335 \u65289 \
    let LEAVE_FILTER_MODE = 'matrix'; // 'matrix' | 'record'\
    // \uc0\u9989  \u26032 \u22686 \u65306 \u20986 \u21220 \u35352 \u37636 \u65288 \u21015 \u24335 \u65289 \u29992 \u25628 \u23563 \u29376 \u24907 \u20633 \u20221 \
    let savedSearchForLeaveFilter = null;\
\
    const EXCLUDE_SET = new Set([\
      '\uc0\u26410 ','\u22283 ',\
      '\uc0\u20363 ','\u20363 \u20551 \u26085 ','\u20363 \u20241 ',\
      '\uc0\u20241 ','\u20241 \u20551 ','\u20241 \u20551 \u26085 ',\
      '\uc0\u35519 \u20489 ','\u35519 \u20219 ','\u38626 ',\
      '\uc0\u36681 \u27491 '\
    ]);\
\
    const EXCLUDE_FROM_DENOM = new Set([\
      '\uc0\u20241 ','\u20363 ','\u20363 \u20241 ','\u20363 \u20551 ','\u20363 \u20551 \u26085 ',\
      '\uc0\u20241 \u20551 ','\u20241 \u20551 \u26085 ',\
      '\uc0\u38626 ','\u26410 ',\
      '\uc0\u22283 ','\u22283 \u23450 ','\u22283 \u20986 ',\
      '\uc0\u35519 \u20489 ','\u35519 \u20219 ','\u35519 \u20551 ',\
      '\uc0\u20241 \u21152 ','\u20844 \u20551 ','\u39089 \u39080 ',\
      '\uc0\u36681 \u27491 '\
    ]);\
\
    const EXCLUDE_FROM_ABS   = new Set(['\uc0\u35519 \u20489 ','\u35519 \u20219 ']);\
    const ALNUM_RE = /^[A-Za-z0-9]+$/;\
    const HAS_CJK_RE = /[\\u4E00-\\u9FFF]/;\
\
    const EXCLUDE_FOR_ATT_RATE = new Set([\
      '\uc0\u20241 ','\u20241 \u20551 ','\u20241 \u20551 \u26085 ',\
      '\uc0\u20363 ','\u20363 \u20551 ','\u20363 \u20241 ','\u20363 \u20551 \u26085 ',\
      '\uc0\u35519 \u20219 ','\u35519 \u20489 ',\
      '\uc0\u38626 ','\u26410 ',\
      '\uc0\u36681 \u27491 ',\
      '\uc0\u39089 \u39080 ','\u20844 \u20551 '\
    ]);\
\
    // \uc0\u9989  \u30331 \u20837 \u35352 \u25014 \u65288 \u26412 \u27231  localStorage\u65289 \u65292 \u19981 \u33258 \u21205 \u22635 \u20837 \u65307 \u20677 \u20445 \u30041  10 \u26085 \u20839 \
    const LOGIN_HISTORY_KEY = 'hs_login_history_v1';\
    const LOGIN_HISTORY_MAX = 6;\
    const LOGIN_HISTORY_TTL_DAYS = 10;\
    const LOGIN_HISTORY_TTL_MS = LOGIN_HISTORY_TTL_DAYS * 24 * 60 * 60 * 1000;\
\
    let loginSuggestOpen = false;\
    let loginSuggestAnchor = null;\
\
    function getLoginHistoryRaw_() \{\
      try \{\
        const raw = localStorage.getItem(LOGIN_HISTORY_KEY);\
        const arr = raw ? JSON.parse(raw) : [];\
        return Array.isArray(arr) ? arr : [];\
      \} catch (e) \{\
        return [];\
      \}\
    \}\
\
    function setLoginHistory(arr) \{\
      try \{\
        localStorage.setItem(LOGIN_HISTORY_KEY, JSON.stringify(arr || []));\
      \} catch (e) \{\}\
    \}\
\
    function getLoginHistory() \{\
      const now = Date.now();\
      let arr = getLoginHistoryRaw_();\
\
      // \uc0\u9989  \u21482 \u20445 \u30041  10 \u26085 \u20839 \u30340 \u35352 \u37636 \u65288 \u36926 \u26399 \u33258 \u21205 \u28165 \u25481 \u65289 \
      const pruned = arr.filter(x => \{\
        const ts = x && typeof x.ts === 'number' ? x.ts : 0;\
        return ts > 0 && (now - ts) <= LOGIN_HISTORY_TTL_MS;\
      \});\
\
      if (pruned.length !== arr.length) \{\
        setLoginHistory(pruned);\
      \}\
\
      return pruned;\
    \}\
\
    function saveLoginHistory(name, birthday) \{\
      const nm = String(name || '').trim();\
      const bd = String(birthday || '').trim();\
      if (!nm || !bd) return;\
\
      const now = Date.now();\
      let arr = getLoginHistory(); // \uc0\u24050 \u33258 \u21205  prune\
\
      // \uc0\u21435 \u37325 \u65288 \u21516 \u21517 \u21516 \u29983 \u26085 \u65289 \u8594  \u26356 \u26032 \u21040 \u26368 \u21069 \
      arr = arr.filter(x => !(String(x.name || '').trim() === nm && String(x.birthday || '').trim() === bd));\
      arr.unshift(\{ name: nm, birthday: bd, ts: now \});\
\
      if (arr.length > LOGIN_HISTORY_MAX) arr = arr.slice(0, LOGIN_HISTORY_MAX);\
      setLoginHistory(arr);\
    \}\
\
    function renderLoginHistory() \{\
      if (!loginHistoryWrap || !loginHistoryList) return;\
\
      const arr = getLoginHistory();\
      if (!arr.length) \{\
        loginHistoryList.innerHTML = '';\
        loginHistoryWrap.style.display = 'none';\
        loginHistoryWrap.setAttribute('aria-hidden', 'true');\
        loginSuggestOpen = false;\
        loginSuggestAnchor = null;\
        return;\
      \}\
\
      loginHistoryList.innerHTML = arr.map((x, idx) => \{\
        const nm = escapeHTML(x.name || '');\
        const bd = escapeHTML(x.birthday || '');\
        return (\
          '<div class="login-chip" role="button" tabindex="0" data-login-idx="' + idx + '">' +\
            '<span class="nm">' + nm + '</span>' +\
            '<span class="bd">\uc0\u65372 ' + bd + '</span>' +\
          '</div>'\
        );\
      \}).join('');\
      // \uc0\u9989  \u19981 \u22312 \u36889 \u35041 \u30452 \u25509 \u39023 \u31034 \u65306 \u39023 \u31034 \u30001  showLoginHistorySuggest \u25511 \u21046 \
    \}\
\
    function positionLoginHistoryWrap_(anchorEl) \{\
      if (!loginHistoryWrap || !anchorEl) return;\
\
      const panel = document.querySelector('.login-panel');\
      if (!panel) return;\
\
      const pr = panel.getBoundingClientRect();\
      const ir = anchorEl.getBoundingClientRect();\
\
      const top = (ir.bottom - pr.top) + 8;\
      const left = (ir.left - pr.left);\
      const width = ir.width;\
\
      loginHistoryWrap.style.top = top + 'px';\
      loginHistoryWrap.style.left = left + 'px';\
      loginHistoryWrap.style.width = Math.max(220, width) + 'px';\
    \}\
\
    function showLoginHistorySuggest(anchorEl) \{\
      if (!loginHistoryWrap || !loginHistoryList) return;\
\
      renderLoginHistory();\
\
      const arr = getLoginHistory();\
      if (!arr.length) return;\
\
      loginSuggestAnchor = anchorEl || loginSuggestAnchor || loginNameInput;\
      positionLoginHistoryWrap_(loginSuggestAnchor);\
\
      loginHistoryWrap.style.display = 'block';\
      loginHistoryWrap.setAttribute('aria-hidden', 'false');\
      loginSuggestOpen = true;\
    \}\
\
    function hideLoginHistorySuggest() \{\
      if (!loginHistoryWrap) return;\
      loginHistoryWrap.style.display = 'none';\
      loginHistoryWrap.setAttribute('aria-hidden', 'true');\
      loginSuggestOpen = false;\
      loginSuggestAnchor = null;\
    \}\
\
    // \uc0\u9989  \u40670 \u20219 \u19968 \u36664 \u20837 \u26694  \u8594  \u20986 \u29694 \u21205 \u24907 \u26694 \u65288 \u21487 \u40670 \u36984 \u65289 \
    if (loginNameInput) \{\
      loginNameInput.addEventListener('focus', function () \{\
        showLoginHistorySuggest(loginNameInput);\
      \});\
      loginNameInput.addEventListener('click', function () \{\
        showLoginHistorySuggest(loginNameInput);\
      \});\
    \}\
\
    if (loginBirthdayInput) \{\
      loginBirthdayInput.addEventListener('focus', function () \{\
        showLoginHistorySuggest(loginBirthdayInput);\
      \});\
      loginBirthdayInput.addEventListener('click', function () \{\
        showLoginHistorySuggest(loginBirthdayInput);\
      \});\
    \}\
\
    // \uc0\u9989  \u40670 \u22806 \u38754 \u33258 \u21205 \u38364 \u38281 \u65288 \u19981 \u24433 \u38911 \u40670 \u36984  chip\u65289 \
    document.addEventListener('mousedown', function (e) \{\
      if (!loginSuggestOpen) return;\
      const t = e.target;\
      if (!loginHistoryWrap) return;\
      if (loginHistoryWrap.contains(t)) return;\
      if (t === loginNameInput || t === loginBirthdayInput) return;\
      hideLoginHistorySuggest();\
    \});\
\
    // \uc0\u9989  \u35222 \u31383 \u22823 \u23567 \u35722 \u21205 \u26178 \u33509 \u38283 \u33879 \u65292 \u37325 \u31639 \u20301 \u32622 \
    window.addEventListener('resize', function () \{\
      if (!loginSuggestOpen || !loginSuggestAnchor) return;\
      positionLoginHistoryWrap_(loginSuggestAnchor);\
    \});\
\
    if (loginHistoryList) \{\
      loginHistoryList.addEventListener('click', function (e) \{\
        const el = e.target.closest('[data-login-idx]');\
        if (!el) return;\
        const idx = parseInt(el.getAttribute('data-login-idx'), 10);\
        const arr = getLoginHistory();\
        const item = arr[idx];\
        if (!item) return;\
\
        // \uc0\u9989  \u21482 \u26377 \u40670 \u25802 \u25165 \u24118 \u20837 \u65288 \u19981 \u33258 \u21205 \u22635 \u20837 \u65289 \
        loginNameInput.value = String(item.name || '');\
        loginBirthdayInput.value = String(item.birthday || '');\
        loginBirthdayInput.focus();\
\
        hideLoginHistorySuggest();\
      \});\
\
      loginHistoryList.addEventListener('keydown', function (e) \{\
        if (e.key !== 'Enter') return;\
        const el = e.target.closest('[data-login-idx]');\
        if (!el) return;\
        el.click();\
      \});\
    \}\
\
    if (clearLoginHistoryBtn) \{\
      clearLoginHistoryBtn.addEventListener('click', function () \{\
        try \{ localStorage.removeItem(LOGIN_HISTORY_KEY); \} catch (e) \{\}\
        renderLoginHistory();\
        hideLoginHistorySuggest();\
      \});\
    \}\
\
    function setLoading(text) \{\
      if (text) \{\
        loadingMsg.innerHTML =\
          '<span class="msg-inline-icon">\uc0\u9203 </span><span>' + escapeHTML(text) + '</span>';\
      \} else \{\
        loadingMsg.innerHTML = '';\
      \}\
    \}\
\
    function escapeHTML(s) \{\
      return String(s == null ? '' : s)\
        .replace(/&/g, '&amp;')\
        .replace(/</g, '&lt;')\
        .replace(/>/g, '&gt;')\
        .replace(/"/g, '&quot;');\
    \}\
\
    // \uc0\u9989  \u26032 \u22686 \u65306 regex escape\u65288 \u20986 \u21220 \u35352 \u37636 \u21015 \u24335 \u31721 \u36984 \u29992 \u65289 \
    function escapeRegex(s) \{\
      return String(s == null ? '' : s).replace(/[.*+?^$\{\}()|[\\]\\\\]/g, '\\\\$&');\
    \}\
\
    // \uc0\u9989  \u20462 \u27491 \u65306 \u27396 \u20301 \u39023 \u31034 /\u38577 \u34255 \u24460 \u65292 \u24375 \u21046 \u21516 \u27493 \u34920 \u38957 \u33287 \u34920 \u26684 \u23532 \u24230 \u65288 \u20570 \u20841 \u27425 \u65292 \u36991 \u20813 \u20598 \u30332 \u19981 \u23565 \u40778 \u65289 \
    function syncDtLayout_() \{\
      if (!table) return;\
      try \{\
        table.columns.adjust().draw(false);\
      \} catch (e) \{\}\
      requestAnimationFrame(function () \{\
        if (!table) return;\
        try \{\
          table.columns.adjust().draw(false);\
        \} catch (e) \{\}\
      \});\
    \}\
\
    function fmtMDFromISO(iso) \{\
      if (!iso) return '';\
      const d = new Date(iso + 'T00:00:00Z');\
      return (d.getUTCMonth() + 1) + '/' + d.getUTCDate();\
    \}\
\
    function compareMD(a, b) \{\
      const pa = String(a).split('/');\
      const pb = String(b).split('/');\
      if (pa.length !== 2 || pb.length !== 2) return String(a).localeCompare(String(b), 'en-US', \{ numeric: true \});\
      const am = parseInt(pa[0], 10) || 0;\
      const ad = parseInt(pa[1], 10) || 0;\
      const bm = parseInt(pb[0], 10) || 0;\
      const bd = parseInt(pb[1], 10) || 0;\
      if (am === bm) return ad - bd;\
      return am - bm;\
    \}\
\
    // \uc0\u9989  \u26032 \u22686 \u65306 \u35336 \u31639 \u20998 \u38913 \u20154 \u25976 \u33287 \u38626 \u32887 \u20154 \u25976 \
    function computePageStats() \{\
      const headers = LAST.headers || [];\
      const rows = LAST.rows || [];\
      const nameCol = findNameCol(headers);\
      \
      if (nameCol < 0 || rows.length === 0) \{\
        pageTotal.textContent = '0';\
        pageLeave.textContent = '\uc0\u38626 \u32887 \u65306 0';\
        return;\
      \}\
      \
      const peopleSet = new Set();\
      const leaveSet = new Set();\
      \
      // \uc0\u9989  \u20462 \u27491 \u65306 \u32113 \u35336 \u21508 \u20154 \u21729 \u35442 \u21015 \u26377 "\u38626 "\u25991 \u23383 \u21063 \u31639 1\
      rows.forEach(row => \{\
        const name = String(row.v[nameCol] || '').trim();\
        if (!name) return;\
        \
        // \uc0\u27298 \u26597 \u35442 \u34892 \u25152 \u26377 \u27396 \u20301 \u26159 \u21542 \u21253 \u21547 \u12300 \u38626 \u12301 \u23383 \
        let isLeave = false;\
        for (let col = 0; col < row.v.length; col++) \{\
          const cellValue = String(row.v[col] || '').trim();\
          if (cellValue.indexOf('\uc0\u38626 ') >= 0) \{\
            isLeave = true;\
            break;\
          \}\
        \}\
        \
        if (isLeave) \{\
          leaveSet.add(name);\
        \} else \{\
          peopleSet.add(name);\
        \}\
      \});\
      \
      const total = peopleSet.size + leaveSet.size;\
      \
      pageTotal.textContent = total + ' \uc0\u20154 ';\
      pageLeave.textContent = '\uc0\u38626 \u32887 \u65306 ' + leaveSet.size + ' \u20154 ';\
    \}\
\
    function parseCellForRules(cell) \{\
      const raw = (cell || '').toString().trim();\
      if (!raw) return \{ excludeDen: false, excludeAbs: false, tokens: [] \};\
      const tokens = raw.split(/[\uc0\u12289 \u65292 ,;\u65295 \\/\\n]+/).map(x => x.trim()).filter(Boolean);\
      const excludeDen = tokens.some(t => EXCLUDE_FROM_DENOM.has(t));\
      const excludeAbs = tokens.some(t => EXCLUDE_FROM_ABS.has(t)) ||\
        (tokens.length === 1 && ALNUM_RE.test(tokens[0]) && !HAS_CJK_RE.test(tokens[0]));\
      return \{ excludeDen, excludeAbs, tokens \};\
    \}\
\
    function tokenizeCell(raw) \{\
      const info = parseCellForRules(raw);\
      return info.tokens.filter(t => !EXCLUDE_SET.has(t));\
    \}\
\
    // \uc0\u9989  \u21934 \u20154 \u20551 \u21029 \u27396 \u20301 \u31721 \u36984 \u65306 \u35201 \u21253 \u21547 \u12300 \u20241 /\u20363 /\u22283 /\u26410 \u12301 \u31561 \u29677 \u34920 \u24120 \u29992 \u27161 \u35352 \u65292 \u22240 \u27492 \u19981 \u22871 \u29992  EXCLUDE_SET\
    function tokenizeCellForLeaveFilter(raw) \{\
      const info = parseCellForRules(raw);\
      return info.tokens.filter(Boolean);\
    \}\
\
    // \uc0\u9989  \u21934 \u20154 \u20551 \u21029 \u27396 \u20301 \u31721 \u36984 \u65306 \u33509 \u24460 \u31471 \u27794 \u26377 \u36776 \u35672 \u20986  dateCols\u65288 \u20363 \u22914 \u12300 12/16(\u20108 )\u12301 \u36889 \u31278 \u34920 \u38957 \u65289 \u65292 \u21069 \u31471 \u29992 \u36611 \u23532 \u39686 \u35215 \u21063 \u35036 \u25235 \u19968 \u27425 \
    function detectDateColsFromHeadersForLeaveFilter_(headers) \{\
      const res = [];\
      if (!headers || !headers.length) return res;\
      for (let i = 0; i < headers.length; i++) \{\
        const h = String(headers[i] || '').trim();\
        if (!h) continue;\
        // yyyy/mm/dd \uc0\u25110  yyyy-mm-dd\u65288 \u21487 \u21253 \u21547 \u20854 \u20182 \u23383 \u65292 \u22914 \u12300 (\u20108 )\u12301 \u65289 \
        if (/(\\d\{4\})[\\/\\-](\\d\{1,2\})[\\/\\-](\\d\{1,2\})/.test(h)) \{ res.push(i); continue; \}\
        // mm/dd \uc0\u25110  m/d\u65288 \u21487 \u21253 \u21547 \u20854 \u20182 \u23383 \u65289 \
        if (/(\\d\{1,2\})[\\/\\-](\\d\{1,2\})/.test(h)) \{ res.push(i); continue; \}\
        // 12\uc0\u26376 16\u26085 \
        if (/(\\d\{1,2\})\uc0\u26376 (\\d\{1,2\})\u26085 /.test(h)) \{ res.push(i); continue; \}\
      \}\
      return res;\
    \}\
\
\
    // \uc0\u21069 \u31471  findNameCol\u65288 \u21152 \u24375 \u29256 \u65292 \u36319 \u24460 \u31471 \u21516 \u27493 \u65289 \
    function findNameCol(headers) \{\
      if (!headers || !headers.length) return -1;\
\
      const EXACT = ['\uc0\u22995 \u21517 ','Name','name','\u21729 \u24037 \u22995 \u21517 ','\u22995 \u21517 (\u24517 \u22635 )','\u20013 \u25991 \u22995 \u21517 '];\
      for (let i = 0; i < headers.length; i++) \{\
        const h = String(headers[i] || '').trim();\
        if (!h) continue;\
        if (EXACT.indexOf(h) >= 0) return i;\
      \}\
\
      for (let i = 0; i < headers.length; i++) \{\
        const h = String(headers[i] || '').trim();\
        if (!h) continue;\
        if (\
          h.indexOf('\uc0\u22995 \u21517 ') >= 0 ||\
          h.indexOf('\uc0\u21729 \u24037 ') >= 0 ||\
          /^name$/i.test(h) ||\
          /employee/i.test(h)\
        ) \{\
          return i;\
        \}\
      \}\
      return -1;\
    \}\
\
    // \uc0\u9989  \u26032 \u22686 \u65306 \u25214 \u12300 \u26085 \u26399 \u12301 \u27396 \
    function findDateCol(headers) \{\
      if (!headers || !headers.length) return -1;\
      for (let i = 0; i < headers.length; i++) \{\
        const h = String(headers[i] || '').trim();\
        if (!h) continue;\
        if (h.indexOf('\uc0\u26085 \u26399 ') >= 0 || /^date$/i.test(h)) return i;\
      \}\
      return -1;\
    \}\
\
    // \uc0\u9989  \u26032 \u22686 \u65306 \u25214 \u12300 \u20551 \u21029 \u12301 \u27396 \
    function findLeaveCol(headers) \{\
      if (!headers || !headers.length) return -1;\
\
      const EXACT = ['\uc0\u20551 \u21029 ','\u35531 \u20551 ','\u20241 \u20551 \u39006 \u21029 ','\u32570 \u21220 \u39006 \u21029 ','\u29376 \u24907 ','\u20986 \u21220 \u29376 \u24907 '];\
      for (let i = 0; i < headers.length; i++) \{\
        const h = String(headers[i] || '').trim();\
        if (!h) continue;\
        if (EXACT.indexOf(h) >= 0) return i;\
      \}\
\
      for (let i = 0; i < headers.length; i++) \{\
        const h = String(headers[i] || '').trim();\
        if (!h) continue;\
        if (h.indexOf('\uc0\u26085 \u26399 ') >= 0 || h.indexOf('\u22995 \u21517 ') >= 0) continue;\
        if (h.indexOf('\uc0\u20551 ') >= 0 || h.indexOf('\u35531 \u20551 ') >= 0 || h.indexOf('\u32570 \u21220 ') >= 0 || h.indexOf('\u29376 \u24907 ') >= 0) \{\
          return i;\
        \}\
      \}\
      return -1;\
    \}\
\
    // \uc0\u9989  \u26032 \u22686 \u65306 \u35299 \u26512 \u20219 \u24847 \u26085 \u26399 \u23383 \u20018  \u8594  ISO\
    function guessISOFromText(t) \{\
      const s = String(t || '').trim();\
      if (!s) return '';\
\
      let m = s.match(/^(\\d\{4\})[\\/\\-](\\d\{1,2\})[\\/\\-](\\d\{1,2\})$/);\
      if (m) \{\
        const y = m[1];\
        const mo = ('0' + m[2]).slice(-2);\
        const d = ('0' + m[3]).slice(-2);\
        return y + '-' + mo + '-' + d;\
      \}\
\
      m = s.match(/^(\\d\{1,2\})[\\/\\-](\\d\{1,2\})$/);\
      if (m) \{\
        const y = String(new Date().getFullYear());\
        const mo = ('0' + m[1]).slice(-2);\
        const d = ('0' + m[2]).slice(-2);\
        return y + '-' + mo + '-' + d;\
      \}\
\
      m = s.match(/^(?:(\\d\{4\})\uc0\u24180 )?\\s*(\\d\{1,2\})\u26376 \\s*(\\d\{1,2\})\u26085 $/);\
      if (m) \{\
        const y = m[1] || String(new Date().getFullYear());\
        const mo = ('0' + m[2]).slice(-2);\
        const d = ('0' + m[3]).slice(-2);\
        return y + '-' + mo + '-' + d;\
      \}\
\
      const dt = new Date(s);\
      if (!isNaN(dt.getTime())) \{\
        const y = dt.getFullYear();\
        const mo = ('0' + (dt.getMonth() + 1)).slice(-2);\
        const d = ('0' + dt.getDate()).slice(-2);\
        return y + '-' + mo + '-' + d;\
      \}\
\
      return '';\
    \}\
\
    function findDeptCol(headers) \{\
      if (!headers || !headers.length) return -1;\
\
      const EXACT = ['\uc0\u32068 \u21029 ','\u37096 \u38272 ','Group','\u32676 \u32068 ','\u35506 \u21029 ','\u21934 \u20301 ','\u37096 \u38272 \u21029 '];\
      for (let i = 0; i < headers.length; i++) \{\
        const h = String(headers[i] || '').trim();\
        if (!h) continue;\
        if (EXACT.indexOf(h) >= 0) return i;\
      \}\
\
      for (let i = 0; i < headers.length; i++) \{\
        const h = String(headers[i] || '').trim();\
        if (!h) continue;\
        if (\
          h.indexOf('\uc0\u37096 \u38272 ') >= 0 ||\
          h.indexOf('\uc0\u32068 \u21029 ') >= 0 ||\
          h.indexOf('\uc0\u32676 \u32068 ') >= 0 ||\
          h.indexOf('\uc0\u35506 \u21029 ') >= 0 ||\
          h.indexOf('\uc0\u21934 \u20301 ') >= 0 ||\
          /dept|department|group/i.test(h)\
        ) \{\
          return i;\
        \}\
      \}\
      return -1;\
    \}\
\
    function findShiftCol(headers) \{\
      const CANDS = ['\uc0\u29677 \u21029 ','\u29677 \u27425 '];\
      for (let i = 0; i < headers.length; i++) \{\
        const h = String(headers[i] || '').trim();\
        if (CANDS.indexOf(h) >= 0) return i;\
      \}\
      return -1;\
    \}\
\
    function findEmpIdCol(headers) \{\
      const CANDS = ['\uc0\u21729 \u32232 ','\u24037 \u34399 ','\u21729 \u24037 \u32232 \u34399 ','\u21729 \u24037 \u20195 \u34399 '];\
      for (let i = 0; i < headers.length; i++) \{\
        const h = String(headers[i] || '').trim();\
        if (CANDS.indexOf(h) >= 0) return i;\
      \}\
      return -1;\
    \}\
\
    function updateBrandLabel() \{\
      if (!warehouseSub) return;\
      if (currentWarehouse) \{\
        warehouseSub.textContent = currentWarehouse + ' \uc0\u20986 \u21220 \u26597 \u35426 ';\
      \} else \{\
        warehouseSub.textContent = '\uc0\u20986 \u21220 \u26597 \u35426 ';\
      \}\
    \}\
\
    function updateStatsVisibility() \{\
      const isScheduleSheet = currentSheet && currentSheet.indexOf('\uc0\u29677 \u34920 ') >= 0;\
      const isRecordSheet   = currentSheet && currentSheet.indexOf('\uc0\u20986 \u21220 \u35352 \u37636 ') >= 0;\
\
      const isLeaveStatSheet = isScheduleSheet || isRecordSheet;\
\
      // \uc0\u9989  \u20462 \u27491 \u65306 \u20986 \u21220 \u35352 \u37636 \u20998 \u38913 \u20063 \u35201 \u26377 \u27492 \u21151 \u33021 \
      leaveFilterBlock.style.display  = isLeaveStatSheet ? 'block' : 'none';\
      singleStatBlock.style.display   = isLeaveStatSheet ? 'block' : 'none';\
      attStatBlock.style.display      = isScheduleSheet ? 'block' : 'none';\
      adminNameBlock.style.display    = (isLeaveStatSheet && isAdmin) ? 'block' : 'none';\
      allAttStatBlock.style.display   = (isScheduleSheet && isAdmin) ? 'block' : 'none';\
\
      if (warehouseBlock) \{\
        warehouseBlock.style.display = isAdmin ? 'flex' : 'none';\
      \}\
      if (openSheetBlock) \{\
        openSheetBlock.style.display = isAdmin ? 'flex' : 'none';\
      \}\
      // \uc0\u9989  \u31649 \u29702 \u32773 \u25165 \u38656 \u35201 \u65306 \u38928 \u20808 \u21047 \u26032 \u12300 \u38283 \u21855 \u35430 \u31639 \u34920 \u12301 \u36899 \u32080 \u65288 \u36991 \u20813 \u40670 \u25802 \u26178 \u25165 \u25235 \u65292 \u23566 \u33268 \u34987 \u28687 \u35261 \u22120 \u30070 \u25104  popup\u65289 \
      if (isAdmin) \{\
        try \{ refreshOpenSheetLink_(); \} catch (_) \{\}\
      \}\
    \}\
\
    function updateFreezeOptions() \{\
      const headers = LAST.headers || [];\
      if (!headers.length) \{\
        freezeStart.innerHTML = '';\
        freezeEnd.innerHTML = '';\
        return;\
      \}\
      const opts = headers.map((t, i) =>\
        '<option value="' + i + '">' + (i + 1) + '. ' + escapeHTML(t || '') + '</option>'\
      ).join('');\
      freezeStart.innerHTML = opts;\
      freezeEnd.innerHTML = opts;\
      freezeStart.value = '0';\
      freezeEnd.value = '0';\
    \}\
\
    function renderTableWithFrozen() \{\
      if (lastPayload) renderTable(lastPayload);\
    \}\
\
    function updateLeaveFilterOptions() \{\
      const prevTag = leaveFilterSelect.value || '';\
      let rows = LAST.rows || [];\
      try \{\
        // \uc0\u9989  \u20381  DataTables \u30446 \u21069 \u25628 \u23563 \u32080 \u26524 \u65288 \u22995 \u21517 \u25628 \u23563 \u26694 \u65289 \u38480 \u23450 \u12300 \u21934 \u20154 \u12301 \u31684 \u22285 \
        if (table) rows = table.rows(\{ search: 'applied' \}).data().toArray();\
      \} catch (e) \{\}\
      const headers = LAST.headers || [];\
      let dateCols = LAST.dateCols || [];\
\
      // \uc0\u9989  fallback\u65306 \u26576 \u20123  DataTables \u21021 \u22987 \u21270 /\u25628 \u23563 \u24310 \u36978 \u26178 \u65292 API \u21487 \u33021 \u26283 \u26178 \u25235 \u19981 \u21040  applied rows\
      if ((!rows || !rows.length) && LAST && Array.isArray(LAST.rows) && LAST.rows.length) \{\
        const inputEl = document.querySelector('#tbl_wrapper .dt-search input, #tbl_filter input');\
        const q = inputEl ? String(inputEl.value || '').trim() : '';\
        if (q) \{\
          const ql = q.toLowerCase();\
          rows = LAST.rows.filter(r => \{\
            const s = (r && r.v) ? r.v.join(' ') : '';\
            return s.toLowerCase().indexOf(ql) >= 0;\
          \});\
        \} else \{\
          rows = LAST.rows;\
        \}\
      \}\
\
      // \uc0\u9989  dateCols \u35036 \u25235 \u65288 \u21482 \u24433 \u38911 \u21934 \u20154 \u20551 \u21029 \u27396 \u20301 \u31721 \u36984 \u65292 \u19981 \u21205 \u20854 \u20182 \u32113 \u35336 \u65289 \
      if (!Array.isArray(dateCols) || dateCols.length === 0) \{\
        dateCols = detectDateColsFromHeadersForLeaveFilter_(headers);\
      \}\
\
      // \uc0\u37325 \u32622 \u27169 \u24335 \
      LEAVE_FILTER_MODE = (Array.isArray(dateCols) && dateCols.length > 0) ? 'matrix' : 'record';\
\
      const set = new Set();\
\
      if (!rows.length) \{\
        leaveFilterSelect.innerHTML = '<option value="">\uc0\u20840 \u37096 \u26085 \u26399 </option>';\
        leaveFilterSelect.disabled = true;\
        clearLeaveFilterBtn.disabled = true;\
        return;\
      \}\
\
      if (LEAVE_FILTER_MODE === 'matrix') \{\
        // \uc0\u29677 \u34920 \u65306 \u24478 \u26085 \u26399 \u27396 \u20301 \u21462  token\u65292 \u39023 \u31034 \u12300 \u26377 \u35442 \u20551 \u21029 \u12301 \u30340 \u26085 \u26399 \u27396 \
        dateCols.forEach(ci => \{\
          rows.forEach(row => \{\
            tokenizeCellForLeaveFilter(row.v[ci]).forEach(tag => set.add(tag));\
          \});\
        \});\
      \} else \{\
        // \uc0\u20986 \u21220 \u35352 \u37636 \u65306 \u25214 \u12300 \u20551 \u21029 /\u29376 \u24907 \u12301 \u27396 \u65292 \u20570 \u21015 \u24335 \u36942 \u28670 \
        const leaveIdx = findLeaveCol(headers);\
        if (leaveIdx < 0) \{\
          leaveFilterSelect.innerHTML = '<option value="">\uc0\u20840 \u37096 \u26085 \u26399 </option>';\
          leaveFilterSelect.disabled = true;\
          clearLeaveFilterBtn.disabled = true;\
          return;\
        \}\
        rows.forEach(row => \{\
          tokenizeCellForLeaveFilter(row.v[leaveIdx]).forEach(tag => set.add(tag));\
        \});\
      \}\
\
      if (!set.size) \{\
        leaveFilterSelect.innerHTML = '<option value="">\uc0\u20840 \u37096 \u26085 \u26399 </option>';\
        leaveFilterSelect.disabled = true;\
        clearLeaveFilterBtn.disabled = true;\
        return;\
      \}\
\
      const options = ['<option value="">\uc0\u20840 \u37096 \u26085 \u26399 </option>'].concat(\
        [...set].sort((a, b) => a.localeCompare(b, 'zh-HANT')).map(t =>\
          '<option value="' + escapeHTML(t) + '">' + escapeHTML(t) + '</option>'\
        )\
      );\
      leaveFilterSelect.innerHTML = options.join('');\
      leaveFilterSelect.disabled = false;\
      clearLeaveFilterBtn.disabled = false;\
\
      // \uc0\u9989  \u20445 \u30041 \u21407 \u36984 \u21462 \u65288 \u20363 \u22914 \u31649 \u29702 \u32773 \u29992 \u25628 \u23563 \u26694 \u20999 \u25563 \u22995 \u21517 \u26178 \u65289 \
      if (prevTag) \{\
        const exists = Array.from(leaveFilterSelect.options).some(o => o.value === prevTag);\
        leaveFilterSelect.value = exists ? prevTag : '';\
      \}\
    \}\
\
    function applyLeaveFilterInternal(tag) \{\
      if (!table || !tag) return;\
      const headers = LAST.headers || [];\
      let rows = LAST.rows || [];\
      try \{\
        // \uc0\u9989  \u20381  DataTables \u30446 \u21069 \u25628 \u23563 \u32080 \u26524 \u65288 \u22995 \u21517 \u25628 \u23563 \u26694 \u65289 \u38480 \u23450 \u12300 \u21934 \u20154 \u12301 \u31684 \u22285 \
        if (table) rows = table.rows(\{ search: 'applied' \}).data().toArray();\
      \} catch (e) \{\}\
\
      // \uc0\u9989  fallback\u65306 \u26576 \u20123  DataTables \u21021 \u22987 \u21270 /\u25628 \u23563 \u24310 \u36978 \u26178 \u65292 API \u21487 \u33021 \u26283 \u26178 \u25235 \u19981 \u21040  applied rows\
      if ((!rows || !rows.length) && LAST && Array.isArray(LAST.rows) && LAST.rows.length) \{\
        const inputEl = document.querySelector('#tbl_wrapper .dt-search input, #tbl_filter input');\
        const q = inputEl ? String(inputEl.value || '').trim() : '';\
        if (q) \{\
          const ql = q.toLowerCase();\
          rows = LAST.rows.filter(r => \{\
            const s = (r && r.v) ? r.v.join(' ') : '';\
            return s.toLowerCase().indexOf(ql) >= 0;\
          \});\
        \} else \{\
          rows = LAST.rows;\
        \}\
      \}\
\
      // \uc0\u9989  dateCols \u35036 \u25235 \u65288 \u21482 \u24433 \u38911 \u21934 \u20154 \u20551 \u21029 \u27396 \u20301 \u31721 \u36984 \u65289 \
      let dateCols = LAST.dateCols || [];\
      if (!Array.isArray(dateCols) || dateCols.length === 0) \{\
        dateCols = detectDateColsFromHeadersForLeaveFilter_(headers);\
      \}\
\
      if (!headers.length || !rows.length) return;\
\
      if (LEAVE_FILTER_MODE === 'matrix') \{\
        // \uc0\u29677 \u34920 \u65306 \u27396 \u20301 \u39023 \u31034 /\u38577 \u34255 \u65288 \u21482 \u20445 \u30041 \u21547 \u35442 \u20551 \u21029 \u30340 \u26085 \u26399 \u27396 \u65289 \
        if (!dateCols.length) return;\
\
        if (!savedVisibilityForLeaveFilter) \{\
          savedVisibilityForLeaveFilter = table.columns().visible().toArray();\
        \}\
\
        const vis = savedVisibilityForLeaveFilter.slice();\
\
        // \uc0\u9989  \u20854 \u20182 \u27396 \u20301 \u19981 \u35722 \u65306 \u21482 \u20381 \u20551 \u21029 \u27770 \u23450 \u21738 \u20123 \u12300 \u26085 \u26399 \u27396 \u12301 \u35201 \u39023 \u31034 \
        dateCols.forEach(ci => \{\
          let has = false;\
          for (let r = 0; r < rows.length; r++) \{\
            const toks = tokenizeCellForLeaveFilter(rows[r].v[ci]);\
            if (toks.includes(tag)) \{\
              has = true;\
              break;\
            \}\
          \}\
          vis[ci] = has;\
        \});\
\
        vis.forEach((v, idx) => table.column(idx).visible(v, false));\
        table.columns.adjust().draw(false);\
\
        // \uc0\u9989  \u20462 \u27491 \u65306 \u27396 \u20301 \u31721 \u36984 \u24460 \u24375 \u21046 \u21516 \u27493 \u34920 \u38957 /\u27396 \u20301 \u23532 \u24230 \u65292 \u36991 \u20813 \u19981 \u23565 \u40778 \u25110 \u34920 \u38957 \u28040 \u22833 \
        syncDtLayout_();\
      \} else \{\
        // \uc0\u20986 \u21220 \u35352 \u37636 \u65306 \u20197 \u12300 \u20551 \u21029 /\u29376 \u24907 \u12301 \u27396 \u20570 \u21015 \u24335 \u36942 \u28670 \
        const leaveIdx = findLeaveCol(headers);\
        if (leaveIdx < 0) return;\
\
        if (!savedSearchForLeaveFilter) \{\
          savedSearchForLeaveFilter = \{\
            global: table.search(),\
            leave: table.column(leaveIdx).search()\
          \};\
        \}\
\
        // \uc0\u20197  token \u37002 \u30028 \u20570  regex\u65288 \u26356 \u28310 \u65289 \
        const re = '(^|[\\\\s\\\\n\uc0\u12289 \u65292 ,;\u65295 /])' + escapeRegex(tag) + '($|[\\\\s\\\\n\u12289 \u65292 ,;\u65295 /])';\
        table.column(leaveIdx).search(re, true, false);\
        table.draw(false);\
\
        // \uc0\u9989  \u21516 \u27493 \u23532 \u24230 \u65288 \u20986 \u21220 \u35352 \u37636 \u20063 \u21487 \u33021 \u26377  scrollX \u36896 \u25104 \u23565 \u40778 \u21839 \u38988 \u65289 \
        syncDtLayout_();\
      \}\
    \}\
\
    function clearLeaveFilterInternal() \{\
      if (!table) return;\
\
      if (LEAVE_FILTER_MODE === 'matrix') \{\
        if (savedVisibilityForLeaveFilter) \{\
          savedVisibilityForLeaveFilter.forEach((v, idx) => table.column(idx).visible(v, false));\
        \} else \{\
          table.columns().visible(true, false);\
        \}\
        table.columns.adjust().draw(false);\
        savedVisibilityForLeaveFilter = null;\
        leaveFilterSelect.value = '';\
\
        // \uc0\u9989  \u20462 \u27491 \u65306 \u28165 \u38500 \u24460 \u20063 \u24375 \u21046 \u21516 \u27493 \u19968 \u27425 \
        syncDtLayout_();\
        return;\
      \}\
\
      // record mode\uc0\u65306 \u28165 \u25481 \u27396 \u20301 \u25628 \u23563 \u20006 \u36996 \u21407 \
      const headers = LAST.headers || [];\
      const leaveIdx = findLeaveCol(headers);\
      if (leaveIdx >= 0) \{\
        if (savedSearchForLeaveFilter) \{\
          table.search(savedSearchForLeaveFilter.global || '');\
          table.column(leaveIdx).search(savedSearchForLeaveFilter.leave || '');\
        \} else \{\
          table.column(leaveIdx).search('');\
        \}\
        table.draw(false);\
      \}\
      savedSearchForLeaveFilter = null;\
      leaveFilterSelect.value = '';\
\
      // \uc0\u9989  \u21516 \u27493 \u19968 \u27425 \
      syncDtLayout_();\
    \}\
\
    function destroySingleStat() \{\
      if (singleStatDT) \{\
        singleStatDT.destroy();\
        singleStatDT = null;\
      \}\
      document.getElementById('singleStatTbl').innerHTML = '';\
      singleStatTitle.textContent = '\'97';\
      if (singleStatCaption) singleStatCaption.textContent = '\'97';\
    \}\
\
    function destroyAttStat() \{\
      if (attStatDT) \{\
        attStatDT.destroy();\
        attStatDT = null;\
      \}\
      document.getElementById('attStatTbl').innerHTML = '';\
      attStatTitle.textContent = '\'97';\
    \}\
\
    function destroyAllAttStat() \{\
      if (allAttStatDT) \{\
        allAttStatDT.destroy();\
        allAttStatDT = null;\
      \}\
      document.getElementById('allAttStatTbl').innerHTML = '';\
      allAttStatTitle.textContent = '\'97';\
    \}\
\
    async function downloadElementAsPNG(el, filenameBase) \{\
      if (!el) return;\
      const canvas = await html2canvas(el, \{ backgroundColor: '#FFFFFF', scale: 2 \});\
      const url = canvas.toDataURL('image/png');\
      const a = document.createElement('a');\
      a.href = url;\
      a.download = filenameBase + '.png';\
      a.click();\
    \}\
\
    function buildSingleStat() \{\
      if (!loginName) \{\
        alert('\uc0\u35531 \u20808 \u30331 \u20837 \u24460 \u20877 \u20351 \u29992 \u21934 \u20154 \u20551 \u21029 \u32113 \u35336 ');\
        return;\
      \}\
\
      const headers = LAST.headers || [];\
      const headersISO = LAST.headersISO || [];\
      const allRows = LAST.rows || [];\
      const dateCols = LAST.dateCols || [];\
\
      if (!allRows.length) \{\
        alert('\uc0\u30446 \u21069 \u20998 \u38913 \u27794 \u26377 \u21487 \u32113 \u35336 \u30340 \u36039 \u26009 \u12290 ');\
        return;\
      \}\
\
      const targetName = isAdmin ? (statName || '') : loginName;\
      if (isAdmin && !targetName) \{\
        alert('\uc0\u35531 \u20808 \u36664 \u20837 \u35201 \u32113 \u35336 \u30340 \u22995 \u21517 \u65288 \u31649 \u29702 \u32773 \u22995 \u21517 \u36984 \u25799 \u21312 \u22602 \u65289 ');\
        return;\
      \}\
\
      let rows = allRows;\
      const nameCol = findNameCol(headers);\
      if (targetName && nameCol >= 0) \{\
        rows = allRows.filter(r => String(r.v[nameCol] || '').trim() === targetName);\
      \}\
\
      if (!rows.length) \{\
        alert('\uc0\u25214 \u19981 \u21040 \u22995 \u21517 \u12300 ' + targetName + '\u12301 \u30340 \u36039 \u26009 ');\
        return;\
      \}\
\
      const displayName = targetName || loginName;\
      const deptLabel = getDeptLabel(headers, allRows, targetName);\
      const shiftLabel = getShiftLabel(headers, rows);\
      const empIdLabel = getEmpIdLabel(headers, rows);\
\
      const parts = [];\
      if (currentSheet) parts.push(currentSheet);\
      if (deptLabel) parts.push(deptLabel);\
      if (shiftLabel) parts.push(shiftLabel);\
      if (empIdLabel) parts.push(empIdLabel);\
      parts.push(displayName);\
      const noteText = parts.join(' ');\
\
      const tagDatesMap = new Map();\
\
      const isMatrixMode = Array.isArray(dateCols) && dateCols.length > 0;\
\
      if (isMatrixMode) \{\
        dateCols.forEach(ci => \{\
          const iso = headersISO[ci] || '';\
          const md = iso ? fmtMDFromISO(iso) : (headers[ci] || '');\
          rows.forEach(row => \{\
            tokenizeCell(row.v[ci]).forEach(tag => \{\
              if (!tagDatesMap.has(tag)) tagDatesMap.set(tag, new Set());\
              tagDatesMap.get(tag).add(md);\
            \});\
          \});\
        \});\
      \} else \{\
        const dateIdx = findDateCol(headers);\
        const leaveIdx = findLeaveCol(headers);\
\
        if (dateIdx < 0 || leaveIdx < 0) \{\
          alert('\uc0\u27492 \u20998 \u38913 \u25214 \u19981 \u21040 \u21487 \u32113 \u35336 \u30340 \u27396 \u20301 \u65288 \u38656 \u35201 \u12300 \u26085 \u26399 \u12301 \u33287 \u12300 \u20551 \u21029 /\u29376 \u24907 \u12301 \u27396 \u65289 \u12290 ');\
          return;\
        \}\
\
        rows.forEach(row => \{\
          const ds = String(row.v[dateIdx] || '').trim();\
          const iso = guessISOFromText(ds);\
          const md = iso ? fmtMDFromISO(iso) : ds;\
\
          const leaveRaw = row.v[leaveIdx];\
          const tags = tokenizeCell(leaveRaw);\
\
          tags.forEach(tag => \{\
            if (!tagDatesMap.has(tag)) tagDatesMap.set(tag, new Set());\
            tagDatesMap.get(tag).add(md);\
          \});\
        \});\
      \}\
\
      if (!tagDatesMap.size) \{\
        alert('\uc0\u27794 \u26377 \u21487 \u32113 \u35336 \u30340 \u20551 \u21029 \u36039 \u26009 \u65288 \u21487 \u33021 \u35442 \u20998 \u38913 \u27794 \u26377 \u20551 \u21029 /\u29376 \u24907 \u20839 \u23481 \u65289 \u12290 ');\
        return;\
      \}\
\
      const data = [...tagDatesMap.entries()].map(([tag, setDates]) => \{\
        const list = Array.from(setDates);\
        list.sort(compareMD);\
        return [tag, list.join('\uc0\u12289 '), list.length];\
      \}).sort((a, b) => a[0].localeCompare(b[0], 'zh-HANT'));\
\
      destroySingleStat();\
\
      singleStatTitle.textContent = (currentSheet || '\uc0\u20998 \u38913 ') + ' \u8231  ' + displayName;\
      const filenameBase = displayName + '_' + (currentSheet || '\uc0\u20998 \u38913 ') + '_\u21934 \u20154 \u20551 \u21029 \u32113 \u35336 ';\
\
      singleStatDT = new DataTable('#singleStatTbl', \{\
        data,\
        columns: [\
          \{ title: '\uc0\u20551 \u21029 ', data: 0 \},\
          \{ title: '\uc0\u26085 \u26399 ', data: 1 \},\
          \{ title: '\uc0\u22825 \u25976 ', data: 2 \}\
        ],\
        order: [[0, 'asc']],\
        pageLength: 25,\
        lengthMenu: [10, 25, 50, 100, 200],\
        language: \{ url: '//cdn.datatables.net/plug-ins/2.3.4/i18n/zh-HANT.json' \},\
        layout: \{\
          topStart: ['search'],\
          topEnd: ['buttons'],\
          bottomStart: ['pageLength'],\
          bottomEnd: ['info', 'paging']\
        \},\
        buttons: [\
          \{\
            extend: 'excelHtml5',\
            text: '\uc0\u21295 \u20986  Excel',\
            title: filenameBase\
          \},\
          \{\
            extend: 'csvHtml5',\
            text: '\uc0\u21295 \u20986  CSV',\
            title: filenameBase\
          \},\
          \{\
            text: '\uc0\u19979 \u36617  PNG',\
            action: function () \{\
              (async function () \{\
                const wrapper = document.getElementById('singleStatTbl')\
                  .closest('.dataTables_wrapper') || singleStatWrap;\
                wrapper.classList.add('export-only-table');\
                try \{\
                  await downloadElementAsPNG(wrapper, filenameBase);\
                \} finally \{\
                  wrapper.classList.remove('export-only-table');\
                \}\
              \})();\
            \}\
          \}\
        ]\
      \});\
\
      (function () \{\
        const tblEl = document.getElementById('singleStatTbl');\
        if (!tblEl) return;\
        let tfoot = tblEl.tFoot;\
        if (!tfoot) \{\
          tfoot = tblEl.createTFoot();\
        \}\
        let tr = tfoot.rows[0];\
        if (!tr) \{\
          tr = tfoot.insertRow(0);\
        \}\
        tr.innerHTML = '';\
        const td = document.createElement('td');\
        td.colSpan = 3;\
        td.textContent = noteText;\
        td.className = 'single-stat-note';\
        tr.appendChild(td);\
      \})();\
    \}\
\
    function isShouldAttendCell(raw) \{\
      const s = (raw == null ? '' : String(raw)).trim();\
      if (!s) return true;\
      const tokens = s.split(/[\uc0\u12289 \u65292 ,;\u65295 \\/\\n]+/).map(x => x.trim()).filter(Boolean);\
      return !tokens.some(t => EXCLUDE_FOR_ATT_RATE.has(t));\
    \}\
\
    function isActualAttendCell(colIndex, row) \{\
      if (row && Array.isArray(row.att) && typeof row.att[colIndex] !== 'undefined') \{\
        return !!row.att[colIndex];\
      \}\
      return false;\
    \}\
\
    function getDeptLabel(headers, allRows, targetName) \{\
      const deptIdx = findDeptCol(headers);\
      if (deptIdx < 0) return '\uc0\u26410 \u22635 \u37096 \u38272 ';\
      const nameIdx = findNameCol(headers);\
      const set = new Set();\
      allRows.forEach(r => \{\
        if (nameIdx >= 0 && targetName) \{\
          const nm = String(r.v[nameIdx] || '').trim();\
          if (nm !== targetName) return;\
        \}\
        const dept = String(r.v[deptIdx] || '').trim();\
        if (dept) set.add(dept);\
      \});\
      if (!set.size) return '\uc0\u26410 \u22635 \u37096 \u38272 ';\
      return Array.from(set).sort((a, b) => a.localeCompare(b, 'zh-HANT')).join('\uc0\u12289 ');\
    \}\
\
    function getShiftLabel(headers, rows) \{\
      const shiftIdx = findShiftCol(headers);\
      if (shiftIdx < 0) return '';\
      const set = new Set();\
      rows.forEach(r => \{\
        const v = String(r.v[shiftIdx] || '').trim();\
        if (v) set.add(v);\
      \});\
      if (!set.size) return '';\
      return Array.from(set).sort((a, b) => a.localeCompare(b, 'zh-HANT')).join('\uc0\u12289 ');\
    \}\
\
    function getEmpIdLabel(headers, rows) \{\
      const empIdx = findEmpIdCol(headers);\
      if (empIdx < 0) return '';\
      const set = new Set();\
      rows.forEach(r => \{\
        const v = String(r.v[empIdx] || '').trim();\
        if (v) set.add(v);\
      \});\
      if (!set.size) return '';\
      return Array.from(set).sort((a, b) => a.localeCompare(b, 'zh-HANT')).join('\uc0\u12289 ');\
    \}\
\
    function updateAttStatDateOptions() \{\
      const dateCols = LAST.dateCols || [];\
      const headers = LAST.headers || [];\
      const headersISO = LAST.headersISO || [];\
\
      ATT_DATE_LIST = [];\
\
      if (!dateCols.length) \{\
        attEndDateSelect.innerHTML = '<option value="">\uc0\u20840 \u37096 \u26085 \u26399 </option>';\
        attSingleDateSelect.innerHTML = '<option value="">\uc0\u19981 \u25351 \u23450 </option>';\
        attEndDateSelect.disabled = true;\
        attSingleDateSelect.disabled = true;\
        buildAttStatBtn.disabled = true;\
        clearAttStatBtn.disabled = true;\
        return;\
      \}\
\
      const tmp = dateCols.map(ci => \{\
        const iso = headersISO[ci] || '';\
        const label = iso ? fmtMDFromISO(iso) : String(headers[ci] || '');\
        return \{ ci, iso, label \};\
      \});\
\
      tmp.sort((a, b) => \{\
        if (a.iso && b.iso && a.iso !== b.iso) return a.iso.localeCompare(b.iso);\
        return compareMD(a.label, b.label);\
      \});\
\
      ATT_DATE_LIST = tmp;\
\
      const endOpts = ['<option value="">\uc0\u20840 \u37096 \u26085 \u26399 </option>'];\
      const singleOpts = ['<option value="">\uc0\u19981 \u25351 \u23450 </option>'];\
\
      ATT_DATE_LIST.forEach(d => \{\
        const val = d.iso || ('idx_' + d.ci);\
        const label = escapeHTML(d.label);\
        endOpts.push('<option value="' + val + '">' + label + '</option>');\
        singleOpts.push('<option value="' + val + '">' + label + '</option>');\
      \});\
\
      attEndDateSelect.innerHTML = endOpts.join('');\
      attSingleDateSelect.innerHTML = singleOpts.join('');\
      attEndDateSelect.disabled = false;\
      attSingleDateSelect.disabled = false;\
      buildAttStatBtn.disabled = false;\
      clearAttStatBtn.disabled = false;\
\
      if (ATT_DATE_LIST.length) \{\
        const last = ATT_DATE_LIST[ATT_DATE_LIST.length - 1];\
        attEndDateSelect.value = last.iso || ('idx_' + last.ci);\
      \}\
    \}\
\
    function getDateIndicesUpToEndSelected() \{\
      const val = attEndDateSelect.value;\
      if (!ATT_DATE_LIST.length) return LAST.dateCols.slice();\
      if (!val) return ATT_DATE_LIST.map(d => d.ci);\
      const idx = ATT_DATE_LIST.findIndex(d => (d.iso || ('idx_' + d.ci)) === val);\
      if (idx === -1) return ATT_DATE_LIST.map(d => d.ci);\
      return ATT_DATE_LIST.slice(0, idx + 1).map(d => d.ci);\
    \}\
\
    function getDateIndexForSingleSelected() \{\
      const val = attSingleDateSelect.value;\
      if (!val || !ATT_DATE_LIST.length) return null;\
      const found = ATT_DATE_LIST.find(d => (d.iso || ('idx_' + d.ci)) === val);\
      return found ? found.ci : null;\
    \}\
\
    function getLabelForEndSelected() \{\
      const val = attEndDateSelect.value;\
      if (!val || !ATT_DATE_LIST.length) return '\uc0\u20840 \u37096 \u26085 \u26399 ';\
      const idx = ATT_DATE_LIST.findIndex(d => (d.iso || ('idx_' + d.ci)) === val);\
      if (idx === -1) return '\uc0\u36215 \u22987 \u26085 \u33267 \u36984 \u25799 \u26085 ';\
      return '\uc0\u36215 \u22987 \u26085 \u33267  ' + ATT_DATE_LIST[idx].label;\
    \}\
\
    function getLabelForSingleSelected(singleIndex) \{\
      if (singleIndex == null || !ATT_DATE_LIST.length) return '';\
      const d = ATT_DATE_LIST.find(x => x.ci === singleIndex);\
      return '\uc0\u21934 \u26085  ' + (d ? d.label : '\u25351 \u23450 \u26085 \u26399 ');\
    \}\
\
    function buildAttStat() \{\
      if (!loginName) \{\
        alert('\uc0\u35531 \u20808 \u30331 \u20837 \u24460 \u20877 \u20351 \u29992 \u20986 \u21220 \u29575 \u32113 \u35336 ');\
        return;\
      \}\
\
      const headers = LAST.headers || [];\
      const allRows = LAST.rows || [];\
      const dateCols = LAST.dateCols || [];\
\
      if (!allRows.length || !dateCols.length) \{\
        alert('\uc0\u30446 \u21069 \u20998 \u38913 \u27794 \u26377 \u21487 \u32113 \u35336 \u30340 \u26085 \u26399 \u27396 \u12290 ');\
        return;\
      \}\
\
      const targetName = isAdmin ? (statName || '') : loginName;\
      if (isAdmin && !targetName) \{\
        alert('\uc0\u35531 \u20808 \u36664 \u20837 \u35201 \u32113 \u35336 \u30340 \u22995 \u21517 \u65288 \u31649 \u29702 \u32773 \u22995 \u21517 \u36984 \u25799 \u21312 \u22602 \u65289 ');\
        return;\
      \}\
\
      let rows = allRows;\
      const nameCol = findNameCol(headers);\
      if (targetName && nameCol >= 0) \{\
        rows = allRows.filter(r => String(r.v[nameCol] || '').trim() === targetName);\
      \}\
\
      if (!rows.length) \{\
        alert('\uc0\u25214 \u19981 \u21040 \u22995 \u21517 \u12300 ' + targetName + '\u12301 \u30340 \u36039 \u26009 ');\
        return;\
      \}\
\
      if (!ATT_DATE_LIST.length) \{\
        alert('\uc0\u30446 \u21069 \u20998 \u38913 \u27794 \u26377 \u21487 \u32113 \u35336 \u30340 \u26085 \u26399 \u27396 \u12290 ');\
        return;\
      \}\
\
      const displayName = targetName || loginName;\
      const deptLabel = getDeptLabel(headers, allRows, targetName);\
\
      const idxRange = getDateIndicesUpToEndSelected();\
      const singleIdx = getDateIndexForSingleSelected();\
\
      function computeForCols(colIndices) \{\
        let shouldDays = 0;\
        let actDays = 0;\
        rows.forEach(row => \{\
          colIndices.forEach(ci => \{\
            if (isShouldAttendCell(row.v[ci])) \{\
              shouldDays++;\
              if (isActualAttendCell(ci, row)) \{\
                actDays++;\
              \}\
            \}\
          \});\
        \});\
        const absent = shouldDays - actDays;\
        const rate = shouldDays > 0 ? (actDays / shouldDays * 100) : null;\
        return \{ shouldDays, actDays, absent, rate \};\
      \}\
\
      const dataRows = [];\
      const rangeLabel = getLabelForEndSelected();\
      const rangeStat = computeForCols(idxRange);\
      dataRows.push([\
        displayName,\
        deptLabel,\
        rangeLabel,\
        rangeStat.shouldDays,\
        rangeStat.actDays,\
        rangeStat.absent,\
        rangeStat.rate != null ? rangeStat.rate.toFixed(1) + '%' : '\'97'\
      ]);\
\
      if (singleIdx != null) \{\
        const singleLabel = getLabelForSingleSelected(singleIdx);\
        const singleStat = computeForCols([singleIdx]);\
        dataRows.push([\
          displayName,\
          deptLabel,\
          singleLabel,\
          singleStat.shouldDays,\
          singleStat.actDays,\
          singleStat.absent,\
          singleStat.rate != null ? singleStat.rate.toFixed(1) + '%' : '\'97'\
        ]);\
      \}\
\
      destroyAttStat();\
\
      const baseTitle = deptLabel + '_' + displayName + '_' + (currentSheet || '\uc0\u20998 \u38913 ') + '_\u21934 \u20154 \u20986 \u21220 \u29575 \u32113 \u35336 ';\
\
      attStatTitle.textContent = (currentSheet || '\uc0\u20998 \u38913 ') + ' \u8231  ' + deptLabel + ' \u8231  ' + displayName;\
\
      attStatDT = new DataTable('#attStatTbl', \{\
        data: dataRows,\
        columns: [\
          \{ title: '\uc0\u22995 \u21517 ', data: 0 \},\
          \{ title: '\uc0\u37096 \u38272 ', data: 1 \},\
          \{ title: '\uc0\u32113 \u35336 \u31684 \u22285 ', data: 2 \},\
          \{ title: '\uc0\u25033 \u21040 \u22825 \u25976 ', data: 3 \},\
          \{ title: '\uc0\u23526 \u21040 \u22825 \u25976 ', data: 4 \},\
          \{ title: '\uc0\u26410 \u21040 \u22825 \u25976 ', data: 5 \},\
          \{ title: '\uc0\u20986 \u21220 \u29575 ', data: 6 \}\
        ],\
        searching: false,\
        paging: false,\
        info: false,\
        ordering: false,\
        language: \{ url: '//cdn.datatables.net/plug-ins/2.3.4/i18n/zh-HANT.json' \},\
        layout: \{\
          topStart: [],\
          topEnd: ['buttons'],\
          bottomStart: [],\
          bottomEnd: []\
        \},\
        buttons: [\
          \{\
            extend: 'excelHtml5',\
            text: '\uc0\u21295 \u20986  Excel',\
            title: baseTitle\
          \},\
          \{\
            extend: 'csvHtml5',\
            text: '\uc0\u21295 \u20986  CSV',\
            title: baseTitle\
          \},\
          \{\
            text: '\uc0\u19979 \u36617  PNG',\
            action: function () \{\
              downloadElementAsPNG(attStatWrap, baseTitle);\
            \}\
          \}\
        ]\
      \});\
    \}\
\
    function buildAllAttStat() \{\
      if (!loginName) \{\
        alert('\uc0\u35531 \u20808 \u30331 \u20837 \u24460 \u20877 \u20351 \u29992 \u20840 \u21729 \u20986 \u21220 \u29575 \u32113 \u35336 ');\
        return;\
      \}\
      if (!isAdmin) \{\
        alert('\uc0\u20677 \u31649 \u29702 \u32773 \u21487 \u20351 \u29992 \u27492 \u21151 \u33021 ');\
        return;\
      \}\
\
      const headers = LAST.headers || [];\
      const allRows = LAST.rows || [];\
      const dateCols = LAST.dateCols || [];\
\
      if (!allRows.length || !dateCols.length || !ATT_DATE_LIST.length) \{\
        alert('\uc0\u30446 \u21069 \u20998 \u38913 \u27794 \u26377 \u21487 \u32113 \u35336 \u30340 \u26085 \u26399 \u27396 \u12290 ');\
        return;\
      \}\
\
      const nameCol = findNameCol(headers);\
      if (nameCol < 0) \{\
        alert('\uc0\u25214 \u19981 \u21040 \u22995 \u21517 \u27396 \u20301 ');\
        return;\
      \}\
\
      const idxRange = getDateIndicesUpToEndSelected();\
      const rangeLabel = getLabelForEndSelected();\
\
      const byName = new Map();\
      allRows.forEach(r => \{\
        const nm = String(r.v[nameCol] || '').trim();\
        if (!nm) return;\
        if (!byName.has(nm)) byName.set(nm, []);\
        byName.get(nm).push(r);\
      \});\
\
      function computeForCols(rows, colIndices) \{\
        let shouldDays = 0;\
        let actDays = 0;\
        rows.forEach(row => \{\
          colIndices.forEach(ci => \{\
            if (isShouldAttendCell(row.v[ci])) \{\
              shouldDays++;\
              if (isActualAttendCell(ci, row)) \{\
                actDays++;\
              \}\
            \}\
          \});\
        \});\
        const rate = shouldDays > 0 ? (actDays / shouldDays * 100) : null;\
        return \{ shouldDays, actDays, rate \};\
      \}\
\
      const dataRows = [];\
      byName.forEach((rows, nm) => \{\
        const deptLabel = getDeptLabel(headers, allRows, nm);\
        const shiftLabel = getShiftLabel(headers, rows) || '';\
        const st = computeForCols(rows, idxRange);\
        dataRows.push([\
          deptLabel,\
          shiftLabel,\
          nm,\
          st.shouldDays,\
          st.actDays,\
          st.rate != null ? st.rate.toFixed(1) + '%' : '\'97'\
        ]);\
      \});\
\
      dataRows.sort((a, b) => \{\
        const da = String(a[0] || '');\
        const db = String(b[0] || '');\
        const cmpDept = da.localeCompare(db, 'zh-HANT');\
        if (cmpDept !== 0) return cmpDept;\
        return String(a[2] || '').localeCompare(String(b[2] || ''), 'zh-HANT');\
      \});\
\
      destroyAllAttStat();\
\
      allAttStatTitle.textContent = (currentSheet || '\uc0\u20998 \u38913 ') + ' \u8231  ' + rangeLabel;\
      const baseTitle = (currentSheet || '\uc0\u20998 \u38913 ') + '_\u20840 \u21729 \u20986 \u21220 \u29575 \u32113 \u35336 _' + rangeLabel;\
\
      allAttStatDT = new DataTable('#allAttStatTbl', \{\
        data: dataRows,\
        columns: [\
          \{ title: '\uc0\u37096 \u38272 ', data: 0 \},\
          \{ title: '\uc0\u29677 \u21029 ', data: 1 \},\
          \{ title: '\uc0\u22995 \u21517 ', data: 2 \},\
          \{ title: '\uc0\u25033 \u21040 \u22825 \u25976 ', data: 3 \},\
          \{ title: '\uc0\u23526 \u21040 \u22825 \u25976 ', data: 4 \},\
          \{ title: '\uc0\u20986 \u21220 \u29575 ', data: 5 \}\
        ],\
        order: [[0, 'asc'], [2, 'asc']],\
        pageLength: 25,\
        lengthMenu: [10, 25, 50, 100, 200],\
        language: \{ url: '//cdn.datatables.net/plug-ins/2.3.4/i18n/zh-HANT.json' \},\
        layout: \{\
          topStart: ['search'],\
          topEnd: ['buttons'],\
          bottomStart: ['pageLength'],\
          bottomEnd: ['info', 'paging']\
        \},\
        buttons: [\
          \{\
            extend: 'excelHtml5',\
            text: '\uc0\u21295 \u20986  Excel',\
            title: baseTitle\
          \},\
          \{\
            extend: 'csvHtml5',\
            text: '\uc0\u21295 \u20986  CSV',\
            title: baseTitle\
          \}\
        ]\
      \});\
    \}\
\
    function buildThead(headers, headersISO) \{\
      const tbl = document.getElementById('tbl');\
      tbl.innerHTML = '';\
      const thead = document.createElement('thead');\
      const tr = document.createElement('tr');\
\
      headers.forEach(function (h, idx) \{\
        const th = document.createElement('th');\
        th.textContent = h || '';\
        const iso = headersISO[idx];\
        if (iso) \{\
          const d = new Date(iso + 'T00:00:00Z');\
          const dow = d.getUTCDay();\
          if (dow === 6) th.classList.add('col-sat');\
          if (dow === 0) th.classList.add('col-sun');\
        \}\
        tr.appendChild(th);\
      \});\
\
      thead.appendChild(tr);\
      tbl.appendChild(thead);\
    \}\
\
    function renderTable(payload) \{\
      lastPayload = payload;\
\
      const HEADERS     = payload.headers    || [];\
      const HEADERS_ISO = payload.headersISO || [];\
      const DATE_COLS   = payload.dateCols   || [];\
      const ROWS        = payload.rows       || [];\
\
      LAST = \{\
        headers: HEADERS,\
        headersISO: HEADERS_ISO,\
        rows: ROWS,\
        dateCols: DATE_COLS\
      \};\
\
      // \uc0\u9989  \u27599 \u27425 \u37325 \u32362 \u37117 \u37325 \u32622 \u20551 \u21029 \u31721 \u36984 \u29376 \u24907 \
      savedVisibilityForLeaveFilter = null;\
      savedSearchForLeaveFilter = null;\
      if (leaveFilterSelect) leaveFilterSelect.value = '';\
\
      if (table) \{\
        table.destroy();\
        table = null;\
      \}\
\
      destroySingleStat();\
      destroyAttStat();\
      destroyAllAttStat();\
\
      buildThead(HEADERS, HEADERS_ISO);\
\
      const cols = HEADERS.map(function (title, idx) \{\
        return \{\
          data: function (row) \{\
            return row.v[idx] || '';\
          \},\
          createdCell: function (td, cellData, rowData) \{\
            const bg = rowData.bg[idx];\
            const fc = rowData.fc[idx];\
            if (bg) td.style.backgroundColor = bg;\
            if (fc) td.style.color = fc;\
\
            if (!bg && DATE_COLS.indexOf(idx) >= 0) \{\
              const iso = HEADERS_ISO[idx];\
              if (iso) \{\
                const d = new Date(iso + 'T00:00:00Z');\
                const dow = d.getUTCDay();\
                if (dow === 6) td.classList.add('col-sat');\
                if (dow === 0) td.classList.add('col-sun');\
              \}\
            \}\
          \}\
        \};\
      \});\
\
      const dtOptions = \{\
        data: ROWS,\
        columns: cols,\
        scrollX: true,\
        pageLength: 50,\
        lengthMenu: [10, 25, 50, 100, 200],\
        order: [],\
        language: \{\
          url: '//cdn.datatables.net/plug-ins/2.3.4/i18n/zh-HANT.json'\
        \},\
        layout: \{\
          topStart: ['search'],\
          topEnd: ['buttons'],\
          bottomStart: ['pageLength'],\
          bottomEnd: ['info', 'paging']\
        \},\
        buttons: [\
          \{\
            extend: 'excelHtml5',\
            text: '\uc0\u21295 \u20986  Excel',\
            title: function () \{\
              const headers = LAST.headers || [];\
              const rows = LAST.rows || [];\
              const targetName = isAdmin ? (statName || '') : loginName;\
              const deptLabel = getDeptLabel(headers, rows, targetName);\
              const baseName = (deptLabel || '\uc0\u37096 \u38272 ') + '_' + (isAdmin ? (targetName || '\u20840 \u37096 ') : (loginName || '\u26597 \u35426 '));\
              return baseName + '_' + (currentSheet || '\uc0\u20998 \u38913 ');\
            \}\
          \},\
          \{\
            extend: 'csvHtml5',\
            text: '\uc0\u21295 \u20986  CSV',\
            title: function () \{\
              const headers = LAST.headers || [];\
              const rows = LAST.rows || [];\
              const targetName = isAdmin ? (statName || '') : loginName;\
              const deptLabel = getDeptLabel(headers, rows, targetName);\
              const baseName = (deptLabel || '\uc0\u37096 \u38272 ') + '_' + (isAdmin ? (targetName || '\u20840 \u37096 ') : (loginName || '\u26597 \u35426 '));\
              return baseName + '_' + (currentSheet || '\uc0\u20998 \u38913 ');\
            \}\
          \}\
        ]\
      \};\
\
      if (currentFrozenLeft > 0) \{\
        dtOptions.fixedColumns = \{ start: true, leftColumns: currentFrozenLeft \};\
      \}\
\
      table = new DataTable('#tbl', dtOptions);\
\
      // \uc0\u9989  \u31649 \u29702 \u32773 \u65306 \u19981 \u20381 \u36084 \u12300 \u31649 \u29702 \u32773 \u22995 \u21517 \u36984 \u25799 \u12301 \u65307 \u30452 \u25509 \u29992  DataTables \u19978 \u26041 \u25628 \u23563 \u26694 \u65288 \u22995 \u21517 \u65289 \u27770 \u23450 \u12300 \u21934 \u20154 \u20551 \u21029 \u27396 \u20301 \u31721 \u36984 \u12301 \u31684 \u22285 \
            (function bindLeaveFilterSync_()\{\
        // \uc0\u9989  \u30446 \u30340 \u65306 \u31649 \u29702 \u32773 \u30331 \u20837 \u26178 \u65292 \u19981 \u20381 \u36084 \u12300 \u31649 \u29702 \u32773 \u22995 \u21517 \u36984 \u25799 \u12301 \u65292 \
        // \uc0\u21482 \u35201 \u20351 \u29992  DataTables \u20998 \u38913 \u25628 \u23563 \u26694 \u65288 \u20840 \u22495 \u25628 \u23563 \u65289 \u36664 \u20837 \u22995 \u21517 \u65292 \u23601 \u33021 \u21363 \u26178 \u29986 \u29983 \u12300 \u20551 \u21029 \u12301 \u19979 \u25289 \u12290 \
        let timer = null;\
\
        function scheduleSync(shouldApply) \{\
          if (!table) return;\
          if (leaveFilterBlock && leaveFilterBlock.style.display === 'none') return;\
\
          if (timer) clearTimeout(timer);\
          timer = setTimeout(function () \{\
            const currentTag = leaveFilterSelect.value || '';\
            updateLeaveFilterOptions();\
\
            // \uc0\u20445 \u30041 \u21407 \u36984 \u21462 \u20006 \u22039 \u35430 \u22871 \u29992 \u65288 \u33509 \u35442 \u20551 \u21029 \u22312 \u26032 \u22995 \u21517 \u19979 \u19981 \u23384 \u22312 \u21063 \u28165 \u38500 \u65289 \
            if (!currentTag) return;\
            const exists = Array.from(leaveFilterSelect.options).some(o => o.value === currentTag);\
            if (exists) \{\
              leaveFilterSelect.value = currentTag;\
              // draw \uc0\u20107 \u20214 \u26371 \u34987  applyLeaveFilterInternal() \u35320 \u30332 \u65307 \u28858 \u36991 \u20813 \u37325 \u32362 \u24490 \u29872 \u65292 \u21482 \u26377 \u22312 \u12300 \u25628 \u23563 /\u36664 \u20837 \u12301 \u26178 \u25165 \u37325 \u26032 \u22871 \u29992 \
              if (shouldApply) \{\
                applyLeaveFilterInternal(currentTag);\
              \}\
            \} else \{\
              // \uc0\u33509 \u35442 \u20551 \u21029 \u22312 \u26032 \u31721 \u36984 \u32080 \u26524 \u20013 \u19981 \u23384 \u22312 \u65292 \u31561 \u21516 \u28165 \u38500 \
              if (shouldApply) \{\
                clearLeaveFilterInternal();\
              \}\
            \}\
          \}, 0);\
        \}\
\
        // \uc0\u9989  \u26368 \u21487 \u38752 \u65306 \u30435 \u32893  DataTables \u30340  draw/search\u65288 \u30906 \u20445 \u36942 \u28670 \u24050 \u23436 \u25104 \u65289 \
        try \{\
          if (table && typeof table.on === 'function') \{\
            table.on('draw', function()\{ scheduleSync(false); \});\
            table.on('search', function()\{ scheduleSync(true); \});\
          \}\
        \} catch (e) \{\}\
\
        // \uc0\u9989  fallback\u65306 \u30452 \u25509 \u30435 \u32893 \u25628 \u23563 \u26694 \u65288 \u19981 \u21516 \u29256 \u26412  DataTables wrapper class \u21487 \u33021 \u19981 \u21516 \u65289 \
        const input = document.querySelector('#tbl_wrapper .dt-search input, #tbl_filter input');\
        if (input) \{\
          input.addEventListener('input', function()\{ scheduleSync(true); \});\
          input.addEventListener('keyup', function()\{ scheduleSync(true); \});\
        \}\
\
        // \uc0\u9989  \u21021 \u27425 \u28210 \u26579 \u65306 \u20063 \u21516 \u27493 \u19968 \u27425 \u65288 \u36991 \u20813 \u21021 \u22987 \u21270 \u26178  rows \u23578 \u26410  ready\u65289 \
        scheduleSync(false);\
      \})();\
;\
\
      if (isAdmin) \{\
        const headers = LAST.headers || [];\
        const rows = LAST.rows || [];\
        const nameIdx = findNameCol(headers);\
        const groupIdx = findDeptCol(headers);\
\
        const deptSet = new Set();\
        const nameSet = new Set();\
\
        rows.forEach(row => \{\
          if (groupIdx >= 0) \{\
            const dept = String(row.v[groupIdx] || '').trim();\
            if (dept) deptSet.add(dept);\
          \}\
          if (nameIdx >= 0) \{\
            const nm = String(row.v[nameIdx] || '').trim();\
            if (nm) nameSet.add(nm);\
          \}\
        \});\
\
        const deptList = Array.from(deptSet)\
          .filter(Boolean)\
          .sort((a, b) => a.localeCompare(b, 'zh-HANT'));\
\
        if (nameIdx >= 0 && nameSet.size > 0) \{\
          kpiSheet.textContent = (nameSet.size || 0) + ' \uc0\u20154 ';\
        \} else \{\
          kpiSheet.textContent = (rows.length || 0) + ' \uc0\u31558 ';\
        \}\
\
        if (deptSet.size > 0) \{\
          kpiCount.textContent =\
            (deptSet.size || 0) + ' \uc0\u20491 \u37096 \u38272 ' +\
            (deptList.length ? '\uc0\u65288 ' + deptList.join('\u12289 ') + '\u65289 ' : '' );\
        \} else \{\
          kpiCount.textContent = (rows.length || 0) + ' \uc0\u31558 \u36039 \u26009 ';\
        \}\
      \} else \{\
        kpiCount.textContent = ROWS.length || 0;\
        const usedSheet = String(payload.sheetNameUsed || '').trim();\
        if (usedSheet && currentSheet && usedSheet !== currentSheet) \{\
          kpiSheet.textContent = (currentSheet || '\'97') + '\uc0\u65288 \u23526 \u35712 \u65306 ' + usedSheet + '\u65289 ';\
        \} else \{\
          kpiSheet.textContent = currentSheet || usedSheet || '\'97';\
        \}\
      \}\
\
      // \uc0\u9989  \u35336 \u31639 \u20998 \u38913 \u20154 \u25976 \u33287 \u38626 \u32887 \u20154 \u25976 \
      computePageStats();\
\
      updateFreezeOptions();\
      updateLeaveFilterOptions();\
      updateAttStatDateOptions();\
\
      // \uc0\u9989  \u21021 \u27425 \u28210 \u26579 \u20063 \u20570 \u19968 \u27425 \u21516 \u27493 \u65288 \u38450 \u27490 \u20598 \u30332 \u34920 \u38957 /\u27396 \u20301 \u23532 \u24230 \u19981 \u21516 \u27493 \u65289 \
      syncDtLayout_();\
    \}\
\
    let loadToken = 0;\
    let lastLoadedSheetUsed = '';\
\
    async function loadGrid() \{\
      if (!loginName) return;\
      setLoading('\uc0\u36617 \u20837 \u36039 \u26009 \u20013 \'85');\
\
      const token = ++loadToken;\
\
      try \{\
        const apiName = isAdmin ? '' : loginName;\
        const wh = isAdmin ? (currentWarehouse || WH_KEY_INIT || '') : (currentWarehouse || WH_KEY_INIT || '');\
        const url = BASE_URL +\
          '?mode=api' +\
          '&wh=' + encodeURIComponent(wh) +\
          '&sheet=' + encodeURIComponent(currentSheet) +\
          '&name=' + encodeURIComponent(apiName);\
        const res = await fetch(url, \{ cache: 'no-store' \});\
        const data = await res.json();\
\
        // \uc0\u9989  \u33509 \u20351 \u29992 \u32773 \u24555 \u36895 \u20999 \u25563 \u20998 \u38913 /\u20489 \u21029 \u65292 \u24573 \u30053 \u33290 \u35531 \u27714 \u22238 \u25033 \u65292 \u36991 \u20813 \u30059 \u38754 \u36339 \u22238 \u33290 \u20998 \u38913 \
        if (token !== loadToken) return;\
\
        if (data && data.error) \{\
          setLoading('\uc0\u24460 \u31471 \u37679 \u35492 \u65306 ' + data.error);\
          return;\
        \}\
\
        // \uc0\u9989  \u20197 \u24460 \u31471 \u23526 \u38555 \u20351 \u29992 \u20998 \u38913 \u21516 \u27493 \u21069 \u31471 \u29376 \u24907 \u65292 \u36991 \u20813 \u31532 \u19968 \u27425 \u36617 \u20837 \u20998 \u38913 \u36339 \u21205 \
        const used = String(data && data.sheetNameUsed ? data.sheetNameUsed : '').trim();\
        if (used) \{\
          lastLoadedSheetUsed = used;\
          if (currentSheet !== used) \{\
            currentSheet = used;\
            try \{\
              if (sheetSelect && sheetSelect.value !== used) \{\
                sheetSelect.value = used;\
              \}\
            \} catch (_) \{\}\
          \}\
        \}\
\
        renderTable(data);\
        setLoading('');\
      \} catch (err) \{\
        setLoading('\uc0\u36617 \u20837 \u22833 \u25943 \u65306 ' + err);\
      \}\
    \}\
\
    function enterApp(name, isAdminFlag, skipInitialLoad) \{\
      loginName = name;\
      isAdmin   = !!isAdminFlag;\
      statName  = isAdmin ? '' : name;\
\
      userDisplayName.textContent = name;\
      kpiName.textContent = name;\
      kpiSheet.textContent = currentSheet || '\'97';\
\
      statNameInput.value = statName;\
\
      currentWarehouse = WH_KEY_INIT || currentWarehouse || '';\
      if (warehouseSelect) \{\
        warehouseSelect.value = currentWarehouse;\
      \}\
      if (openWarehouseSelect) \{\
        openWarehouseSelect.value = currentWarehouse || WH_KEY_INIT || '';\
      \}\
      updateBrandLabel();\
\
      loginPage.style.display = 'none';\
      appPage.style.display = 'block';\
\
      updateStatsVisibility();\
\
      if (!skipInitialLoad) \{\
        loadGrid();\
      \}\
    \}\
\
    function doLogin() \{\
      const name = loginNameInput.value.trim();\
      const birthday = loginBirthdayInput.value.trim();\
      loginError.textContent = '';\
\
      if (!name || !birthday) \{\
        loginError.textContent = '\uc0\u35531 \u36664 \u20837 \u22995 \u21517 \u33287 \u29983 \u26085 \u12290 ';\
        return;\
      \}\
\
      loginBtn.disabled = true;\
      loginBtn.innerHTML = '<span>\uc0\u39511 \u35657 \u20013 \'85</span>';\
\
      google.script.run\
        .withSuccessHandler(function (res) \{\
          loginBtn.disabled = false;\
          loginBtn.innerHTML = '<span>\uc0\u30331 \u20837 \u31995 \u32113 </span>';\
          if (!res || !res.ok) \{\
            loginError.textContent = (res && res.msg) ? res.msg : '\uc0\u30331 \u20837 \u22833 \u25943 \u65292 \u35531 \u31245 \u24460 \u20877 \u35430 \u12290 ';\
            return;\
          \}\
\
          // \uc0\u9989  \u25104 \u21151 \u30331 \u20837 \u25165 \u23384 \u65307 \u19981 \u33258 \u21205 \u22635 \u20837 \u65306 \u21482 \u26356 \u26032 \u28165 \u21934 \
          saveLoginHistory(name, birthday);\
          renderLoginHistory();\
\
          hideLoginHistorySuggest();\
\
          // \uc0\u9989  \u20808 \u36914 \u20027 \u30059 \u38754 \u65292 \u36991 \u20813 \u31561 \u24453  getSheets \u26178 \u21345 \u22312 \u30331 \u20837 \u38913 \
          enterApp(res.name, !!res.isAdmin, true);\
          setLoading('\uc0\u36617 \u20837 \u36039 \u26009 \u20013 \'85');\
\
          (async function () \{\
            try \{\
              const wk = String(res.warehouseKey || res.whKey || res.warehouse || '').trim();\
              if (wk) \{\
                currentWarehouse = wk;\
                if (warehouseSelect) warehouseSelect.value = wk;\
                updateBrandLabel();\
\
                // \uc0\u9989  \u20808 \u36617 \u20837 \u36039 \u26009 \u65288 \u35731 \u24460 \u31471 \u33258 \u34892 \u36984 \u38928 \u35373 \u20998 \u38913 \u20006 \u22238 \u20659  sheetNameUsed\u65289 \u65292 \u19981 \u31561 \u24453  getSheets\
                currentSheet = '';\
                if (loginName) loadGrid();\
\
                const url = BASE_URL + '?mode=getSheets&wh=' + encodeURIComponent(wk);\
                const r = await fetch(url, \{ cache: 'no-store' \});\
                const data = await r.json();\
                let names = data && data.sheetNames ? data.sheetNames : [];\
                if (!Array.isArray(names)) names = [];\
                if (names.length) \{\
                  const cur = currentSheet;\
                  const hasCur = cur && names.indexOf(cur) >= 0;\
                  let prefer = '';\
                  if (names.indexOf('\uc0\u20986 \u21220 \u35352 \u37636 ') >= 0) prefer = '\u20986 \u21220 \u35352 \u37636 ';\
                  else if (names.indexOf('\uc0\u29677 \u34920 ') >= 0) prefer = '\u29677 \u34920 ';\
                  else prefer = names[0];\
\
                  // \uc0\u9989  \u21482 \u26377 \u30070 \u30446 \u21069 \u20998 \u38913 \u19981 \u23384 \u22312 \u26178 \u65292 \u25165 \u20999 \u21040  prefer\
                  if (!hasCur) currentSheet = prefer;\
\
                  const optsHtml = names.map(function (nm) \{\
                    return '<option value="' + escapeHTML(nm) + '"' +\
                      (nm === currentSheet ? ' selected' : '') +\
                      '>' + escapeHTML(nm) + '</option>';\
                  \}).join('');\
                  sheetSelect.innerHTML = optsHtml;\
                  kpiSheet.textContent = currentSheet || '\'97';\
\
                  // \uc0\u9989  \u36991 \u20813 \u31532 \u19968 \u27425 \u36617 \u20837 \u12300 \u36339 \u20998 \u38913 \u12301 \u65306 \u21482 \u26377 \u30495 \u30340 \u38656 \u35201 \u25563 \u20998 \u38913 \u19988 \u30446 \u21069 \u36039 \u26009 \u19981 \u26159 \u35442 \u20998 \u38913 \u26178 \u25165 \u37325 \u36617 \
                  if (!hasCur && loginName && currentSheet && lastLoadedSheetUsed && currentSheet !== lastLoadedSheetUsed) \{\
                    loadGrid();\
                  \}\
                \}\
              \}\
            \} catch (_) \{\}\
          \})();\
        \})\
        .withFailureHandler(function (err) \{\
          loginBtn.disabled = false;\
          loginBtn.innerHTML = '<span>\uc0\u30331 \u20837 \u31995 \u32113 </span>';\
          loginError.textContent = '\uc0\u31995 \u32113 \u37679 \u35492 \u65306 ' + (err && err.message ? err.message : err);\
        \})\
        .verifyLogin(name, birthday);\
    \}\
\
    loginBtn.addEventListener('click', doLogin);\
\
    logoutBtn.addEventListener('click', function () \{\
      loginName = '';\
      isAdmin = false;\
      statName = '';\
      currentWarehouse = WH_KEY_INIT || '';\
\
      userDisplayName.textContent = '\'97';\
      kpiName.textContent = '\'97';\
      kpiSheet.textContent = '\'97';\
      kpiCount.textContent = '\'97';\
      pageTotal.textContent = '\'97';\
      pageLeave.textContent = '\'97';\
\
      if (table) \{\
        table.destroy();\
        table = null;\
      \}\
      const tblEl = document.getElementById('tbl');\
      if (tblEl) tblEl.innerHTML = '';\
\
      destroySingleStat();\
      destroyAttStat();\
      destroyAllAttStat();\
\
      if (warehouseSelect) \{\
        warehouseSelect.value = currentWarehouse;\
      \}\
      if (openWarehouseSelect) \{\
        openWarehouseSelect.value = currentWarehouse || WH_KEY_INIT || '';\
      \}\
      updateBrandLabel();\
\
      sheetSelect.value = SHEET_INIT || '';\
      currentSheet = SHEET_INIT;\
      updateStatsVisibility();\
\
      loginNameInput.value = '';\
      loginBirthdayInput.value = '';\
      loginError.textContent = '';\
\
      appPage.style.display = 'none';\
      loginPage.style.display = 'flex';\
\
      // \uc0\u9989  \u22238 \u21040 \u30331 \u20837 \u38913 \u65306 \u19981 \u33258 \u21205 \u22635 \u20837 \u65292 \u21482 \u26356 \u26032 \u28165 \u21934 \u65288 \u40670 \u36664 \u20837 \u26694 \u25165 \u26371 \u39023 \u31034 \u65289 \
      renderLoginHistory();\
      hideLoginHistorySuggest();\
    \});\
\
    loginBirthdayInput.addEventListener('keydown', function (e) \{\
      if (e.key === 'Enter') doLogin();\
    \});\
    loginNameInput.addEventListener('keydown', function (e) \{\
      if (e.key === 'Enter') \{\
        e.preventDefault();\
        loginBirthdayInput.focus();\
      \}\
    \});\
\
    sheetSelect.addEventListener('change', function () \{\
      currentSheet = sheetSelect.value;\
      if (!isAdmin) \{\
        kpiSheet.textContent = currentSheet || '\'97';\
      \}\
      updateStatsVisibility();\
      if (loginName) loadGrid();\
    \});\
\
    reloadBtn.addEventListener('click', function () \{\
      if (loginName) loadGrid();\
    \});\
\
    applyFreezeBtn.addEventListener('click', function () \{\
      if (!LAST.headers || !LAST.headers.length) return;\
      const s = parseInt(freezeStart.value, 10);\
      const e = parseInt(freezeEnd.value, 10);\
      if (isNaN(s) || isNaN(e)) return;\
      const maxIndex = Math.max(s, e);\
      currentFrozenLeft = Math.min(LAST.headers.length, maxIndex + 1);\
      renderTableWithFrozen();\
    \});\
\
    resetFreezeBtn.addEventListener('click', function () \{\
      currentFrozenLeft = 0;\
      renderTableWithFrozen();\
    \});\
\
    leaveFilterSelect.addEventListener('change', function () \{\
      const tag = this.value;\
      if (!tag) \{\
        clearLeaveFilterInternal();\
      \} else \{\
        applyLeaveFilterInternal(tag);\
      \}\
    \});\
\
    clearLeaveFilterBtn.addEventListener('click', function () \{\
      clearLeaveFilterInternal();\
    \});\
\
    document.getElementById('buildSingleStat').addEventListener('click', buildSingleStat);\
    document.getElementById('clearSingleStat').addEventListener('click', function () \{\
      destroySingleStat();\
    \});\
\
    statNameInput.addEventListener('input', function () \{\
      statName = this.value.trim();\
    \});\
    clearStatNameBtn.addEventListener('click', function () \{\
      statName = '';\
      statNameInput.value = '';\
    \});\
\
    buildAttStatBtn.addEventListener('click', buildAttStat);\
    clearAttStatBtn.addEventListener('click', function () \{\
      attEndDateSelect.value = '';\
      attSingleDateSelect.value = '';\
      destroyAttStat();\
    \});\
\
    buildAllAttStatBtn.addEventListener('click', buildAllAttStat);\
    clearAllAttStatBtn.addEventListener('click', function () \{\
      destroyAllAttStat();\
    \});\
\
    if (warehouseSelect) \{\
      warehouseSelect.addEventListener('change', async function () \{\
        const selected = warehouseSelect.value;\
        if (!isAdmin) \{\
          warehouseSelect.value = currentWarehouse || WH_KEY_INIT || '';\
          return;\
        \}\
        if (!selected || selected === currentWarehouse) return;\
\
        currentWarehouse = selected;\
        updateBrandLabel();\
\
        setLoading('\uc0\u35712 \u21462  ' + currentWarehouse + ' \u20998 \u38913 \u20013 \'85');\
\
        try \{\
          const url = BASE_URL +\
            '?mode=getSheets&wh=' + encodeURIComponent(currentWarehouse);\
          const res = await fetch(url, \{ cache: 'no-store' \});\
          const data = await res.json();\
          let names = data && data.sheetNames ? data.sheetNames : [];\
          if (!Array.isArray(names)) names = [];\
\
          sheetSelect.innerHTML = '';\
\
          if (!names.length) \{\
            currentSheet = '';\
            kpiSheet.textContent = '\'97';\
            if (table) \{\
              table.destroy();\
              table = null;\
            \}\
            const tblEl = document.getElementById('tbl');\
            if (tblEl) tblEl.innerHTML = '';\
            setLoading('\uc0\u27492 \u20489 \u27794 \u26377 \u21487 \u29992 \u20998 \u38913 ');\
            updateStatsVisibility();\
            return;\
          \}\
\
          let prefer = '';\
          if (names.indexOf('\uc0\u20986 \u21220 \u35352 \u37636 ') >= 0) \{\
            prefer = '\uc0\u20986 \u21220 \u35352 \u37636 ';\
          \} else if (names.indexOf('\uc0\u29677 \u34920 ') >= 0) \{\
            prefer = '\uc0\u29677 \u34920 ';\
          \} else \{\
            prefer = names[0];\
          \}\
          currentSheet = prefer;\
\
          const optsHtml = names.map(function (nm) \{\
            return '<option value="' + escapeHTML(nm) + '"' +\
              (nm === currentSheet ? ' selected' : '') +\
              '>' + escapeHTML(nm) + '</option>';\
          \}).join('');\
          sheetSelect.innerHTML = optsHtml;\
\
          kpiSheet.textContent = currentSheet || '\'97';\
\
          updateStatsVisibility();\
          loadGrid();\
        \} catch (err) \{\
          setLoading('\uc0\u35712 \u21462 \u20998 \u38913 \u28165 \u21934 \u22833 \u25943 \u65306 ' + err);\
        \}\
      \});\
    \}\
\
\
    \
    // \uc0\u9989  \u31649 \u29702 \u32773 \u65306 \u38283 \u21855 \u21508 \u20489  Google Sheet \u35430 \u31639 \u34920 \u65288 \u26032 \u20998 \u38913 \u65289 \
    // \uc0\u36889 \u35041 \u25913 \u25104  <a target="_blank"> \u36899 \u32080 \u65292 \u35731 \u28687 \u35261 \u22120 \u35222 \u28858 \u19968 \u33324 \u36899 \u32080 \u38283 \u26032 \u20998 \u38913 \u65292 \u36991 \u20813 \u34987  popup blocker \u25803 \
    function setOpenSheetLink_(key, sid) \{\
      if (!openSheetBtn) return;\
      if (sid) \{\
        openSheetBtn.href = 'https://docs.google.com/spreadsheets/d/' + sid + '/edit';\
        openSheetBtn.setAttribute('aria-disabled', 'false');\
        // \uc0\u9989  \u35299 \u38500 \u12300 \u19981 \u21487 \u40670 \u12301 \u29376 \u24907 \u65288 \u36991 \u20813  aria-disabled \u26178 \u34987  CSS pointer-events \u25803 \u20303 \u65289 \
        openSheetBtn.style.pointerEvents = '';\
        openSheetBtn.style.cursor = '';\
        openSheetBtn.textContent = '\uc0\u8599  \u38283 \u21855 ';\
      \} else \{\
        // \uc0\u27794 \u25343 \u21040  ID \u26178 \u20808 \u20445 \u30041 \u21407 \u26412 \u34892 \u28858 \u65288 \u30475 \u36215 \u20358 \u26159  disabled\u65289 \u65292 \u20294 \u20801 \u35377 \u40670 \u25802 \u20358 \u35320 \u30332 \u37325 \u26032 \u25235 \u21462 /\u25552 \u31034 \
        openSheetBtn.href = 'javascript:void(0)';\
        openSheetBtn.setAttribute('aria-disabled', 'true');\
        // \uc0\u9989  \u24375 \u21046 \u21487 \u40670 \u65288 \u35206 \u23531  CSS \u30340  pointer-events: none\u65289 \
        openSheetBtn.style.pointerEvents = 'auto';\
        openSheetBtn.style.cursor = 'pointer';\
        openSheetBtn.textContent = '\uc0\u8599  \u38283 \u21855 ';\
      \}\
    \}\
\
    async function refreshOpenSheetLink_() \{\
      if (!openWarehouseSelect) return;\
\
      const key = String(openWarehouseSelect.value || currentWarehouse || WH_KEY_INIT || '').trim();\
\
      // \uc0\u20808 \u29992 \u38913 \u38754 \u27880 \u20837 \u30340  WH_IDS \u21462 \u19968 \u27425 \
      let sid = (WH_IDS && typeof WH_IDS === 'object' && key) ? WH_IDS[key] : '';\
\
      if (sid) \{\
        setOpenSheetLink_(key, sid);\
        return;\
      \}\
\
      // \uc0\u33509  WH_IDS \u27794 \u24118 \u21040 \u65288 \u25110 \u34987 \u24555 \u21462 /\u25130 \u26039 \u65289 \u65292 \u25913 \u21521 \u24460 \u31471 \u35201 \u19968 \u27425  ID\u65288 \u21482 \u26356 \u26032  href\u65292 \u19981 \u20570  window.open\u65289 \
      setOpenSheetLink_(key, '');\
      if (openSheetBtn) openSheetBtn.textContent = '\uc0\u9203  \u35712 \u21462 \u20013 ';\
\
      try \{\
        const res = await fetch(\
          BASE_URL + '?mode=getWarehouseId&wh=' + encodeURIComponent(key),\
          \{ cache: 'no-store' \}\
        );\
        const data = await res.json();\
        if (data && data.ok && data.spreadsheetId) \{\
          sid = data.spreadsheetId;\
          try \{ WH_IDS[key] = sid; \} catch (_) \{\}\
        \}\
      \} catch (_) \{\}\
\
      setOpenSheetLink_(key, sid);\
\
      if (!sid && openSheetBtn) \{\
        openSheetBtn.textContent = '\uc0\u8599  \u38283 \u21855 ';\
      \}\
    \}\
\
    if (openWarehouseSelect) \{\
      openWarehouseSelect.addEventListener('change', function () \{\
        if (!isAdmin) return;\
        refreshOpenSheetLink_();\
      \});\
    \}\
\
    if (openSheetBtn) \{\
      openSheetBtn.addEventListener('click', function (e) \{\
        if (!isAdmin) \{ e.preventDefault(); return; \}\
\
        // \uc0\u36899 \u32080 \u23578 \u26410 \u28310 \u20633 \u22909  \u8594  \u38459 \u27490 \u36339 \u36681 \u20006 \u25552 \u31034 \u65288 \u27491 \u24120 \u24773 \u27841 \u19981 \u26371 \u30332 \u29983 \u65292 \u22240 \u28858  WH_IDS \u24050 \u27880 \u20837 \u65289 \
        const disabled = openSheetBtn.getAttribute('aria-disabled') === 'true';\
        if (disabled || !openSheetBtn.href || openSheetBtn.href.indexOf('docs.google.com/spreadsheets/d/') < 0) \{\
          e.preventDefault();\
          refreshOpenSheetLink_().then(function () \{\
            const ok = openSheetBtn.getAttribute('aria-disabled') !== 'true';\
            if (!ok) \{\
              alert('\uc0\u25214 \u19981 \u21040 \u20489 \u21029 \u35430 \u31639 \u34920  ID\u65306 ' + String(openWarehouseSelect.value || '').trim());\
            \} else \{\
              alert('\uc0\u36899 \u32080 \u24050 \u26356 \u26032 \u65292 \u35531 \u20877 \u40670 \u19968 \u27425 \u12300 \u8599  \u38283 \u21855 \u12301 \u12290 ');\
            \}\
          \});\
        \}\
      \});\
    \}\
\
\
    (function initSheetSelect() \{\
      currentSheet = SHEET_INIT;\
      currentWarehouse = WH_KEY_INIT || currentWarehouse || '';\
      if (warehouseSelect) \{\
        warehouseSelect.value = currentWarehouse;\
      \}\
      if (openWarehouseSelect) \{\
        openWarehouseSelect.value = currentWarehouse || WH_KEY_INIT || '';\
      \}\
      kpiSheet.textContent = currentSheet || '\'97';\
      updateBrandLabel();\
      updateStatsVisibility();\
\
      // \uc0\u9989  \u21021 \u22987 \u21270 \u65306 \u28165 \u29702  10 \u26085 \u36942 \u26399 \u36039 \u26009 \u20006 \u28210 \u26579 \u65288 \u20294 \u19981 \u39023 \u31034 \u65289 \
      renderLoginHistory();\
      hideLoginHistorySuggest();\
    \})();\
  \})();\
</script>\
</body>\
</html>\
}